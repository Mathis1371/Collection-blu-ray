<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="theme-color" content="#2a181c">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google-site-verification" content="bakbfokXXwUl-C9kwrZMrf7ahCAji4nzqde4nIwz9PU" />
  <title>Ma collection de blu-ray ‚Äî Local</title>
  <link rel="manifest" href="manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Interface locale type Netflix pour cataloguer vos films sans lecture vid√©o.">
  <style>
    /* D√©grad√© d'arri√®re-plan discret */
   html, body {
      margin: 0;
      padding: 0;
      background-color: rgb(42, 24, 28); 
      background-image: linear-gradient(to right, rgb(42, 24, 28), rgb(42, 24, 28));
      min-height: 100%;
    }
    .poster { object-fit: cover; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); }

    /* --- Loader anim√© pour les images --- */
   .loading-spinner {
     width: 32px;
     height: 32px;
     border: 3px solid rgba(255,255,255,0.1);
     border-radius: 50%;
     border-top-color: #dc2626; /* Rouge Netflix */
     animation: spin 0.8s linear infinite;
     position: absolute;
     z-index: 0; /* Derri√®re l'image */
   }
   
   @keyframes spin {
     100% { transform: rotate(360deg); }
   }

   /* Classe utilitaire pour centrer le loader dans la boite noire */
   .img-loader-container {
     position: relative;
     background-color: #1a1a1a; /* Fond gris fonc√© en attendant */
     display: flex;
     align-items: center;
     justify-content: center;
     overflow: hidden;
   }

   /* --- Navigation Carrousel style Netflix --- */
   .carousel-wrapper {
     position: relative;
   }

   /* Les boutons (masqu√©s par d√©faut, visibles au survol du wrapper) */
   .nav-btn {
     position: absolute;
     top: 0;
     bottom: 1rem;
     z-index: 40;
     width: 3rem; /* Largeur de la zone cliquable */
     background: rgba(0,0,0,0.5);
     color: white;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     border: none;
     opacity: 0; /* Invisible par d√©faut */
     transition: opacity 0.3s ease, background 0.3s ease;
     font-size: 2rem;
     user-select: none;
   }

   /* Afficher les fl√®ches quand on passe la souris sur la ligne */
   .carousel-wrapper:hover .nav-btn {
     opacity: 1;
   }

   .nav-btn:hover {
     background: rgba(0,0,0,0.8);
     transform: scale(1.1); /* Petit zoom effet pop */
   }

   .nav-left { left: 0; border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
   .nav-right { right: 0; border-top-left-radius: 4px; border-bottom-left-radius: 4px; }

   .carousel {
      scroll-behavior: smooth;
      /* Ajout pour mobile */
      scroll-snap-type: x mandatory; 
      -webkit-overflow-scrolling: touch; /* Pour iOS */
      padding-bottom: 20px; /* Espace pour √©viter de couper l'ombre */
    }

    .carousel-item {
      /* Ajout pour que l'item s'aligne */
      scroll-snap-align: start; 
    }

    /* Cacher d√©finitivement les fl√®ches sur mobile/tactile */
    @media (hover: none) {
      .nav-btn { display: none !important; }
    }

   #netflixBanner {
     width: 100%;
     overflow: hidden;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     position: relative;
     /* On passe le dernier chiffre √† 10px (au lieu de 60px) */
     padding: 20px 0 10px 0; 
   }

   #bannerSection {
     width: 100%;
     height: 420px;
     display: flex;
     align-items: center;
     justify-content: center;
     overflow: hidden;
     position: relative;
   }

   #bannerCarousel {
     display: flex;
     align-items: center;
     gap: 1.5rem;
     transition: transform 0.8s ease; /* animation du translateX */
     will-change: transform;
     width: max-content;         /* s'adapte au contenu */
   }

   .banner-card {
     position: relative;
     width: 900px;
     height: 520px;
     border-radius: 24px;
     overflow: hidden; /* Coupe tout ce qui d√©passe */
     flex-shrink: 0;
     opacity: 0.6;
     transform: scale(0.95);
     transition: transform 0.6s ease, opacity 0.6s ease;
     cursor: pointer;
     background-color: #000; /* Fond noir de s√©curit√© */
     
     /* On enl√®ve tout le reste */
     border: none;
     outline: none;
     box-shadow: none;
   }

   .banner-card::after {
     content: '';
     position: absolute;
     inset: 0; /* Prend toute la taille de la carte */
     border-radius: 24px; /* Suit parfaitement l'arrondi */
     
     /* Une ombre interne de 1px qui mange les pixels blancs sur les bords */
     box-shadow: inset 0 0 0 1px #000; 
     
     z-index: 20; /* Se place PAR-DESSUS l'image */
     pointer-events: none; /* Permet de cliquer au travers */
   }

   .banner-card.active {
     transform: scale(1.03);
     opacity: 1;
     z-index: 2;
   }

   .banner-card img {
     width: 100%;
     height: 100%;
     object-fit: cover;
     display: block;
     border-radius: 24px;
     transform: scale(1.01); 
   }

   .banner-gradient {
     position: absolute;
     bottom: 0; 
     left: 0;
     right: 0;
     height: 40%; 
     
     /* RETOUR AU D√âGRAD√â FLUIDE (sans bordure solide) */
     /* On force le noir pur (#000) sur les 2 premiers % pour la fusion */
     background: linear-gradient(to top, #000 0%, #000 2%, rgba(0,0,0,0.8) 25%, transparent 100%);
     
     pointer-events: none;
     z-index: 5;
     border: none; /* On supprime la bordure moche */
   }

   .banner-info {
     position: absolute;
     bottom: 0;
     left: 0;
     padding: 2rem 2.5rem; 
     width: 100%;
     z-index: 10;
     display: flex;
     flex-direction: column; /* <--- C'est ici qu'√©tait l'erreur (au lieu de flex-col: column) */
     align-items: flex-start;
   }

   .actor-link {
     color: #f87171; /* rouge clair */
     cursor: pointer;
   }
   .actor-link:hover {
   text-decoration: underline;
   }

   .stats-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
     gap: 1rem;
     margin-top: 1rem;
   }

   .stat-card {
     background: rgba(255,255,255,0.03);
     border: 1px solid rgba(255,255,255,0.05);
     padding: 1rem;
     border-radius: 12px;
     min-height: 110px;
   }

   .stat-title { font-size: 0.9rem; color: #cbd5e1; margin-bottom: .5rem; }
   .stat-value { font-size: 1.4rem; font-weight: 700; color: #fff; }

   /* Bar chart simple */
   .genre-bar {
     display: flex;
     gap: .75rem;
     align-items: center;
     margin-bottom: .5rem;
   }
   .genre-label { width: 120px; font-size: .85rem; color: #e6eef8; }
   .bar {
     height: 14px;
     width: 100%;
     background: rgba(255,255,255,0.06);
     border-radius: 999px;
     overflow: hidden;
   }
   .bar-fill {
     height: 100%;
     width: 0%;
     border-radius: 999px;
     background: linear-gradient(90deg,#f97316,#ef4444); /* orange‚Üíred */
     transition: width 600ms ease;
   }

   /* Donut simple (conic-gradient) */
   .donut {
     width: 120px;
     height: 120px;
     border-radius: 50%;
     display:flex;
     align-items:center;
     justify-content:center;
     position: relative;
     margin: 0 auto;
     box-shadow: inset 0 0 0 12px rgba(0,0,0,0.35);
   }
   .donut-center {
     width: 68px;
     height: 68px;
     border-radius: 50%;
     background: rgba(0,0,0,0.6);
     display:flex;
     align-items:center;
     justify-content:center;
     color: #fff;
     font-weight:700;
     font-size: .9rem;
   }

   /* Animation de tremblement pour le gagnant */
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-effect {
      animation: shake 0.5s;
      animation-iteration-count: 1;
    }
   
   .no-scrollbar::-webkit-scrollbar {
     display: none;
   }
   
   .no-scrollbar {
     -ms-overflow-style: none;  /* IE and Edge */
     scrollbar-width: none;  /* Firefox */
   }

   .stats-legend { display:flex; gap: .75rem; align-items:center; justify-content:center; margin-top:.75rem; color:#cbd5e1; font-size: .85rem; }
   .legend-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:.35rem; }

   #bannerCarousel {
     cursor: grab;
   }
   #bannerCarousel:active {
     cursor: grabbing;
   }
   .banner-card img {
     pointer-events: none; /* Emp√™che le navigateur de vouloir glisser l'image elle-m√™me */
     user-select: none;
   }

   /* --- Indicateurs (Points) du Carrousel --- */
   .banner-indicators {
     position: relative;
     margin-top: 30px;        /* <--- Ajoutez 30px d'√©cart ici */
     display: flex;
     justify-content: center;
     gap: 10px;
     z-index: 30;
     padding: 10px;
     border-radius: 20px;
   }
   
   .indicator-dot {
     width: 10px;
     height: 10px;
     border-radius: 50%;
     background-color: rgba(255, 255, 255, 0.3);
     cursor: pointer;
     transition: all 0.3s ease;
     box-shadow: 0 2px 4px rgba(0,0,0,0.5);
   }
   
   .indicator-dot:hover {
     background-color: rgba(255, 255, 255, 0.6);
     transform: scale(1.1);
   }
   
   .indicator-dot.active {
     background-color: #fff;
     transform: scale(1.3);
     box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
   }

   /* --- Styles pour les onglets de la modale --- */
   .tab-button {
      cursor: pointer;
      white-space: nowrap; 
      transition: all 0.2s;
   }

   /* --- RESPONSIVE : Masquer la banni√®re sur mobile --- */
   @media (max-width: 768px) {
     #netflixBanner {
       display: none !important;
     }
     
     /* Optionnel : Ajuster la marge du haut sur mobile pour remonter le contenu */
     #mainView {
        margin-top: 1rem !important;
     }
   }
</style>
</head>
<body class="min-h-screen text-slate-100">
  <header class="sticky top-0 z-30 border-b border-white/10 bg-black/80 backdrop-blur-md">
    <div class="mx-auto max-w-7xl px-4 py-3 flex flex-col lg:flex-row items-center justify-between gap-4 lg:gap-8">
    
       <h1 class="text-2xl sm:text-3xl font-extrabold tracking-wide bg-gradient-to-r from-red-600 via-red-500 to-red-600 bg-clip-text text-transparent drop-shadow-lg shrink-0">
         üé¨ Ma collection
       </h1>

       <nav class="overflow-x-auto no-scrollbar w-full lg:w-auto lg:flex-1 lg:ml-4">
           <ul class="flex items-center justify-center lg:justify-start gap-6 min-w-max">
             <li><button id="tabMain" class="nav-item text-base transition-all duration-300">Accueil</button></li>
             <li><button id="tabGrid" class="nav-item text-base transition-all duration-300">Catalogue</button></li>
             <li><button id="tabUpcoming" class="nav-item text-base transition-all duration-300">Prochainement</button></li>
             <li><button id="tabWishlist" class="nav-item text-base transition-all duration-300">Wishlist</button></li>
             <li><button id="tabStats" class="nav-item text-base transition-all duration-300">Stats</button></li>
             <li><button id="tabBingo" class="nav-item text-base transition-all duration-300">Bingo</button></li>
           </ul>
       </nav>

       <div class="flex items-center gap-3 shrink-0">
           <a id="bugReportBtn" 
              target="_blank" 
              class="cursor-pointer group flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 hover:border-white/40 transition-all duration-300 text-decoration-none">
             <span class="text-lg group-hover:rotate-12 transition-transform">üêõ</span>
             <span class="hidden sm:inline text-sm font-medium text-slate-300 group-hover:text-white">Signaler un bug</span>
           </a>

           <input id="jsonFile" type="file" accept="application/json" class="hidden" />
           <label for="jsonFile" class="cursor-pointer group flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 hover:border-white/40 transition-all duration-300">
             <span class="text-lg group-hover:scale-110 transition-transform">üìÇ</span>
             <span class="text-sm font-medium text-slate-300 group-hover:text-white">Importer JSON</span>
           </label>
       </div>

     </div>
</header>

  <div id="globalFade" 
       class="pointer-events-none fixed top-[80px] right-0 h-[calc(100%-80px)] w-20 
              bg-gradient-to-r from-transparent to-black/80 z-20 hidden"></div>

  <section id="controlsSection" class="mx-auto max-w-7xl px-4 py-6 hidden">
    
    <div class="sm:hidden mb-4">
        <button id="toggleFiltersBtn" class="w-full py-2 bg-white/10 rounded-xl text-sm font-bold uppercase tracking-wide hover:bg-white/20 transition">
            Afficher les filtres & tri
        </button>
    </div>

    <div id="filterInputsContainer" class="hidden sm:grid gap-3 md:grid-cols-12 items-end">
      <div class="md:col-span-5">
        <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Recherche</label>
        <input id="searchInput" type="search" placeholder="Titre, acteur, r√©alisateur, mot-cl√©‚Ä¶" class="w-full px-4 py-3 rounded-2xl bg-white/10 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-red-500" />
      </div>
      <div class="md:col-span-3">
        <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Genre</label>
        <select id="genreSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="">Tous</option>
        </select>
      </div>
      <div class="md:col-span-3">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">P√©riode</label>
       <select id="periodSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Toutes</option>
         <option value="1960-1969">ann√©es 60</option>
         <option value="1970-1979">ann√©es 70</option>
         <option value="1980-1989">ann√©es 80</option>
         <option value="1990-1999">ann√©es 90</option>
         <option value="2000-2009">ann√©es 2000</option>
         <option value="2010-2019">ann√©es 2010</option>
         <option value="2020-2029">ann√©es 2020</option>
       </select>
      </div>
      <div class="md:col-span-3">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Pays</label>
       <select id="countrySelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Tous</option>
       </select>
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Statut</label>
       <select id="seenSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Tous</option>
         <option value="seen">Vus</option>
         <option value="not-seen">Pas vus</option>
       </select>
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Dur√©e</label>
       <select id="runtimeSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Toutes</option>
         <option value="short">Moins de 2h</option>
         <option value="medium">2h √† 2h30</option>
         <option value="long">Plus de 2h30</option>
       </select>
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Ann√©e exacte</label>
       <input id="yearExact" type="number" placeholder="1950" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500" />
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Trier</label>
       <div class="flex gap-2">
         <select id="sortSelect" class="flex-1 px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
           <option value="title">Titre (A‚ÜíZ)</option>
           <option value="year">Ann√©e (‚Üì)</option>
           <option value="rating">Note (‚Üì)</option>
           <option value="runtime">Dur√©e (‚Üì)</option>
           <option value="added">Ajout√© r√©cemment</option>
         </select>
         <button id="sortDirBtn" class="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/20">‚¨ÜÔ∏é</button>
       </div>
      </div>
      <div class="md:col-span-12 mt-4 flex gap-3">
        <button id="resetBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">R√©initialiser</button>
        <button id="randomBtn" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700">Film al√©atoire</button>
      </div>
    </div>
  </section>

  <div id="netflixBanner" class="hidden flex flex-col items-center justify-center overflow-hidden relative">
     <div id="bannerCarousel" class="flex transition-transform duration-700 ease-in-out"></div>
   </div>

  <main id="mainView" class="mx-auto max-w-7xl px-4 pb-24 mt-6"></main>

  <main id="gridView" class="mx-auto max-w-7xl px-4 pb-24 hidden mt-6">
   <div id="resultCount" class="mb-4 text-sm opacity-80"></div>
   <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6"></div>
  </main>

  <main id="upcomingView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>
  <main id="wishlistView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>
  <main id="statsView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>

  <main id="bingoView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>

  <div id="bingoModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
      <div id="bingoBackdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
      <div class="relative w-full max-w-5xl h-[85vh] bg-[#1a1a1a] rounded-3xl border border-white/10 shadow-2xl flex flex-col overflow-hidden transform transition-all scale-95 opacity-0" id="bingoContent">
          
          <div class="relative h-48 shrink-0 overflow-hidden">
              <div class="absolute inset-0 bg-gradient-to-b from-red-900/40 to-[#1a1a1a] z-10"></div>
              <img id="bingoHeaderImg" class="w-full h-full object-cover opacity-50 blur-sm" src="" />
              <div class="absolute bottom-0 left-0 p-6 z-20 flex items-end gap-6 w-full">
                  <div class="w-24 h-24 rounded-full border-4 border-[#1a1a1a] overflow-hidden shadow-xl shrink-0 bg-slate-700">
                      <img id="bingoAvatar" class="w-full h-full object-cover" src="" />
                  </div>
                  <div class="mb-2">
                      <h2 id="bingoDirectorName" class="text-3xl md:text-5xl font-black text-white tracking-tight drop-shadow-lg"></h2>
                      <div class="text-slate-300 text-sm font-medium mt-1 flex items-center gap-2">
                          <span id="bingoScore" class="text-green-400 font-bold text-lg"></span> de compl√©tion
                      </div>
                  </div>
                  <button id="closeBingo" class="ml-auto mb-4 px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-sm font-bold backdrop-blur-md border border-white/10 transition">Fermer</button>
              </div>
          </div>

          <div class="flex-1 overflow-y-auto p-6 bg-[#1a1a1a]">
              <div id="bingoGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                  </div>
          </div>
      </div>
  </div>

  <div id="modal" class="hidden fixed inset-0 z-50">
   <div id="modalBackdrop" class="absolute inset-0 bg-black/70"></div>

   <div id="modalContent"
        class="relative mx-auto mt-16 md:mt-24 w-[95vw] max-w-4xl rounded-2xl bg-black/90 backdrop-blur-xl md:bg-white/5 md:backdrop-blur-md shadow-2xl border border-white/10
              transition-all duration-200 transform scale-95 opacity-0 overflow-hidden flex flex-col max-h-[85vh]">
     
     <button id="modalClose" class="absolute top-2 right-2 z-50 p-1.5 rounded-full bg-black/40 text-white/70 hover:bg-red-600 hover:text-white border border-white/5 backdrop-blur-md transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
     </button>
     
     <div class="overflow-y-auto px-4 pt-4 pb-1.5 md:px-6 md:pt-6 md:pb-4 custom-scrollbar">
       
       <div class="grid grid-cols-12 gap-4 md:gap-5">
         
         <div class="col-span-4 md:col-span-3 md:row-span-6 self-start relative">
            <img id="modalPoster" class="w-full h-auto aspect-[2/3] object-cover rounded-lg shadow-lg border border-white/10" alt="Poster" />
         </div>

         <div class="col-span-8 md:col-span-9 flex flex-col justify-center space-y-1 md:space-y-2">
            <h3 id="modalTitle" class="text-xl md:text-3xl font-black leading-tight text-white drop-shadow-md"></h3>
            
            <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs md:text-sm font-medium text-slate-300" id="modalMeta"></div>
            
            <div id="modalTechBadges" class="flex flex-wrap gap-2 items-center min-h-[1.25rem]"></div>
            
            <div id="modalActionsContainer" class="pt-1"></div>
         </div>

         <div class="col-span-12 md:col-span-9 md:col-start-4">
             
             <div id="modalTabsContainer" class="border-b border-white/10 mb-3 flex gap-4 mt-1">
                <button id="tabOverview" class="tab-button pb-1.5 text-sm font-bold border-b-2 border-red-600 text-red-400">Synopsis</button>
                <button id="tabSpecs" class="tab-button pb-1.5 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-white transition">D√©tails Techniques</button>
             </div>

             <div id="contentOverview" class="animate-fade-in">
                 <div class="space-y-0.5 mb-3 text-xs md:text-sm">
                    <div id="modalDirectors" class="opacity-90"></div> 
                    <div id="modalActors" class="opacity-80 line-clamp-1 md:line-clamp-none"></div>
                 </div>
                 
                 <p id="modalOverview" class="text-slate-200 text-sm leading-relaxed opacity-95"></p>
                 
                 <div class="mt-2 flex flex-wrap items-center gap-3">
                     <div id="modalCountry" class="text-xs opacity-50 font-bold shrink-0"></div>
                     <div id="modalTags" class="flex flex-wrap gap-1.5 opacity-80"></div>
                 </div>
             </div>

             <div id="contentSpecs" class="hidden animate-fade-in">
                 <div class="grid grid-cols-2 gap-2" id="specsGrid"></div>
             </div>

         </div>

       </div>
     </div>
   </div>
  
  <div id="randomRoulette" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-500">
   <div class="relative w-64 h-96 rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(220,38,38,0.4)] border border-white/10 ring-4 ring-white/5">
     <img id="roulettePoster" src="" class="w-full h-full object-cover" />
     <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20"></div>
   </div>
   <h2 id="rouletteTitle" class="mt-8 text-3xl font-bold text-center text-white drop-shadow-lg px-4 animate-pulse">
     Recherche...
   </h2>
   <div class="mt-4 text-red-500 font-mono text-sm tracking-[0.2em] uppercase">S√©lection al√©atoire</div>
  </div>

  <button id="backToTopBtn" class="fixed bottom-6 right-6 z-[9999] p-3 rounded-full bg-red-600 text-white shadow-lg hover:bg-red-700 transition-transform duration-300 scale-0 origin-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </button>

  <script>

    let state = { all: [], filtered: [], query: "", genre: "", yearExact: "", runtime: "", sort: "title", sortDir: "asc", country: "", period: "", seen: ""};
    const els = {
      grid: document.getElementById('grid'),
      search: document.getElementById('searchInput'),
      genre: document.getElementById('genreSelect'),
      seen: document.getElementById('seenSelect'),
      yearExact: document.getElementById('yearExact'),
      runtime: document.getElementById('runtimeSelect'),
      sort: document.getElementById('sortSelect'),
      reset: document.getElementById('resetBtn'),
      count: document.getElementById('resultCount'),
      jsonFile: document.getElementById('jsonFile'),
      period: document.getElementById('periodSelect'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalPoster: document.getElementById('modalPoster'),
      modalTitle: document.getElementById('modalTitle'),
      country: document.getElementById('countrySelect'),
      modalMeta: document.getElementById('modalMeta'),
      modalTechBadges: document.getElementById('modalTechBadges'), 
      modalDirectors: document.getElementById('modalDirectors'),
      modalOverview: document.getElementById('modalOverview'),
      modalTags: document.getElementById('modalTags'),
      modalActors: document.getElementById('modalActors'),
      modalCountry: document.getElementById('modalCountry'),
      modalPrice: document.getElementById('modalPrice'),
      randomBtn: document.getElementById('randomBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      sortDirBtn: document.getElementById('sortDirBtn'),
      // Elements pour les onglets
      tabOverviewBtn: document.getElementById('tabOverview'),
      tabSpecsBtn: document.getElementById('tabSpecs'),
      contentOverview: document.getElementById('contentOverview'),
      contentSpecs: document.getElementById('contentSpecs'),
      specsGrid: document.getElementById('specsGrid'),
      specsNote: document.getElementById('specsNote'),
      modalActionsContainer: document.getElementById('modalActionsContainer')
    };

    const backToTopBtn = document.getElementById('backToTopBtn');
    
    if(backToTopBtn) {
        backToTopBtn.style.transition = "all 0.5s ease";
        backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
        
        setTimeout(() => {
            if (window.scrollY < 100) {
                 backToTopBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            }
        }, 2000);
    }

    window.addEventListener('scroll', () => {
        const scrolled = window.scrollY || document.documentElement.scrollTop;
        
        if (scrolled > 100) {
            backToTopBtn.style.opacity = '1';
            backToTopBtn.style.transform = 'translateY(0)';
            backToTopBtn.style.pointerEvents = 'auto';
            backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
        } else {
            backToTopBtn.style.opacity = '0';
            backToTopBtn.style.transform = 'translateY(40px)'; // On le pousse vers le bas
            backToTopBtn.style.pointerEvents = 'none';
        }
    });

    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const filterInputsContainer = document.getElementById('filterInputsContainer');
    const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
    
    if (toggleFiltersBtn && filterInputsContainer) {
        toggleFiltersBtn.addEventListener('click', () => {
            const isHidden = filterInputsContainer.classList.contains('hidden');
            if (isHidden) {
                filterInputsContainer.classList.remove('hidden');
                toggleFiltersBtn.textContent = "Masquer les filtres & tri";
            } else {
                filterInputsContainer.classList.add('hidden');
                toggleFiltersBtn.textContent = "Afficher les filtres & tri";
            }
        });
    }

    const controlsSection = document.getElementById('controlsSection');
    let currentView = 'netflix';

    const tabMainBtn = document.getElementById("tabMain");
    const tabGridBtn = document.getElementById("tabGrid");
    const tabStatsBtn = document.getElementById("tabStats");
    const statsView = document.getElementById("statsView");

    let currentBannerMovie = null;
    let bannerScrollAnim = null;
    let bannerIndex = 0;
    let bannerMovies = [];
    let bannerInterval = null;

    function setActiveTab(view) {
     const tabs = {
       netflix: tabMainBtn,
       grid: tabGridBtn,
       upcoming: document.getElementById('tabUpcoming'),
       wishlist: document.getElementById('tabWishlist'),
       stats: tabStatsBtn,
       bingo: document.getElementById('tabBingo'),
     };

     const activeClasses = ["text-white", "font-bold", "cursor-default", "scale-105"];
     const inactiveClasses = ["text-slate-400", "font-medium", "hover:text-slate-200", "cursor-pointer"];

     for (const key in tabs) {
         const btn = tabs[key];
         btn.classList.remove(...activeClasses, ...inactiveClasses, "bg-red-600", "bg-white/10", "px-3", "py-1", "rounded"); // Nettoyage des anciennes classes

         if (key === view) {
             btn.classList.add(...activeClasses);
         } else {
             btn.classList.add(...inactiveClasses);
         }
        
         if (currentView === "grid" && view !== "grid") {
             resetFilters();
         }
     }

     const fade = document.getElementById("globalFade");
     if (view === "netflix") {
       fade.classList.remove("hidden");
     } else {
       fade.classList.add("hidden");
     }
     
     // Nettoyage animation
     if (typeof bannerScrollAnim === "number") {
       cancelAnimationFrame(bannerScrollAnim);
       bannerScrollAnim = null;
     }
     if (bannerInterval) {
       clearInterval(bannerInterval);
       bannerInterval = null;
     }
      
     const banner = document.getElementById("netflixBanner");
     if (banner) {
       if (view === "netflix") {
         banner.style.display = "block"; // REVERSION : block comme dans l'original
       } else {
         banner.style.display = "none";
         if (bannerInterval) {
           clearInterval(bannerInterval);
           bannerInterval = null;
         }
         banner.style.transform = "translateX(0)";
       }
     }
     
     if (controlsSection) {
        if (view === 'grid') {
            controlsSection.classList.remove('hidden');
        } else {
            controlsSection.classList.add('hidden');
        }
     }
   }

   setActiveTab(currentView);

   let fuse;

    async function loadInitial() {
      try {
        const res = await fetch('./data/movies.json', { cache: 'no-store' });
        
        if (!res.ok) throw new Error(`Erreur HTTP: ${res.status}`);
        
        let textData = await res.text();
        
        textData = textData.trim();
        
        const lastBrace = textData.lastIndexOf('}');
        
        if (lastBrace !== -1 && lastBrace < textData.length - 1) {
            console.warn("Correction automatique : Suppression de caract√®res en trop √† la fin du JSON");
            textData = textData.substring(0, lastBrace + 1);
        }

        const data = JSON.parse(textData);
        
        if (!data.movies) throw new Error('Pas de cl√© "movies" dans le JSON');
        state.all = normalize(data.movies);
        
      } catch (e) {
        console.error("D√âTAIL DE L'ERREUR :", e);
        console.log("En attente d'import manuel.");
        state.all = []; 
      }
      initFuse();
      initFilters();
      applyFilters();
    }

    function normalize(arr){
      return arr.map(m=>({
        id: m.id ?? (String(m.title) + String(m.year)).replace(/\s+/g, '_').toLowerCase(),
        title: String(m.title||'Sans titre'),
        ean: m.ean ? String(m.ean) : '',
        year: Number(m.year)||null,
        genres: Array.isArray(m.genres)?m.genres:[],
        categories: Array.isArray(m.categories)?m.categories:[],
        people: Array.isArray(m.people)?m.people:[],
        directors: Array.isArray(m.directors)?m.directors:[],
        runtime: Number(m.runtime)||null,
        rating: Number(m.rating)||null,
        price: Number(m.price)||0,
        marketValue: Number(m.marketValue)||0,
        overview: m.overview||'',
        poster: m.poster||'',
        netflixPoster: m.netflixPoster || '',
        altPoster: m.altPoster || '',
        tags: Array.isArray(m.tags)?m.tags:[],
        country: m.country || '',
        added: m.added||new Date().toISOString().slice(0,10),
        technicalSpecs: m.technicalSpecs || null // AJOUT DU CHAMP TECHNIQUE
      }));
    }

    function initFilters(){
      const genres = [...new Set(state.all.flatMap(m=>m.genres))].sort();
      els.genre.innerHTML = '<option value="">Tous</option>' + genres.map(g=>`<option>${g}</option>`).join('');

      const countries = [...new Set(state.all.map(m => m.country).filter(Boolean))].sort();
      els.country.innerHTML = '<option value="">Tous</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
      const validYears = state.all.map(m => m.year).filter(y => y && y > 0);
      
      if (validYears.length > 0) {
          const minYear = Math.min(...validYears);
          const maxYear = Math.max(...validYears);

          els.yearExact.min = minYear;
          els.yearExact.max = maxYear;
          
          els.yearExact.placeholder = `${minYear} - ${maxYear}`;
      }
    }

    function resetFilters() {
     bannerMovies = [];
     bannerIndex = 0;
     state.query = "";
     state.genre = "";
     state.yearExact = "";
     state.runtime = "";
     state.sort = "title";
     state.sortDir = "asc";
     state.country = "";
     state.period = "";
     state.seen = "";

     els.search.value = "";
     els.genre.value = "";
     els.yearExact.value = "";
     els.runtime.value = "";
     els.sort.value = "title";
     els.country.value = "";
     els.period.value = "";
     els.seen.value = "";

     applyFilters();
    }

    function applyFilters() {
        const q = state.query.trim(); 
        const today = new Date();

        let baseList = state.all;

        if (q && typeof fuse !== 'undefined') {
            const results = fuse.search(q);
            baseList = results.map(result => result.item);
        } 
        else if (q) {
            const lowerQ = q.toLowerCase();
            baseList = state.all.filter(m => 
                [m.title, ...(m.people||[]), ...(m.directors||[]), ...(m.tags||[])]
                .join(' ').toLowerCase().includes(lowerQ)
            );
        }

        let list = baseList.filter(m => {

            const matchesG = !state.genre || (m.genres || []).includes(state.genre);
            const matchesY = !state.yearExact || (m.year || 0) === Number(state.yearExact);
            const matchesR = !state.runtime ||
                (state.runtime === "short" && m.runtime && m.runtime < 120) ||
                (state.runtime === "medium" && m.runtime && m.runtime >= 120 && m.runtime <= 150) ||
                (state.runtime === "long" && m.runtime && m.runtime > 150);

            const matchesC = !state.country || (m.country && m.country.toLowerCase().trim() === state.country.toLowerCase().trim());

            const matchesP = !state.period || (() => {
                const [start, end] = state.period.split('-').map(Number);
                return m.year && m.year >= start && m.year <= end;
            })();

            const isSeenInStorage = localStorage.getItem('seen_' + m.id);
            const matchesS = !state.seen || 
                             (state.seen === 'seen' && isSeenInStorage) || 
                             (state.seen === 'not-seen' && !isSeenInStorage);

            const notUpcoming = currentView === 'grid' || currentView === 'netflix' ? (!m.added || new Date(m.added) <= today) : true;

            const notWishlist = currentView === 'wishlist' ? true : !(
                (m.tags && m.tags.includes('wishlist')) ||
                (m.categories && m.categories.includes('wishlist'))
            );

            return matchesG && matchesY && matchesR && matchesC && matchesP && matchesS && notUpcoming && notWishlist;
        });

        list.sort((a, b) => {
            let result = 0;
            switch (state.sort) {
                case 'year': result = (a.year || 0) - (b.year || 0); break;
                case 'rating': result = (a.rating || 0) - (b.rating || 0); break;
                case 'runtime': result = (a.runtime || 0) - (b.runtime || 0); break;
                case 'added': result = String(a.added || '').localeCompare(String(b.added || '')); break;
                default: result = String(a.title || '').localeCompare(String(b.title || '')); break;
            }
            return state.sortDir === "asc" ? result : -result;
        });

        state.filtered = list;

        if (currentView === 'netflix') {
            renderNetflixView();
        } else if (currentView === 'stats') {
            renderStats();
        } else if (currentView === 'wishlist') {
            renderWishlistView();
        } else if (currentView === 'upcoming') {
            renderUpcomingView();
        } else {
            renderGrid();
        }
    }
    
    function renderNetflixView() {
        const container = document.getElementById('mainView');
        container.innerHTML = '';
        container.className = "w-full px-4 py-6 relative";

        const today = new Date();
        const netflixMovies = state.all.filter(m => {
            const isWishlist = (m.tags && m.tags.includes('wishlist')) || (m.categories && m.categories.includes('wishlist'));
            const isUpcoming = (m.added && new Date(m.added) > today);
            return !isWishlist && !isUpcoming;
        });

        if (netflixMovies.length === 0) {
            container.innerHTML = `
              <div class="flex flex-col items-center justify-center h-[60vh] text-center text-slate-400">
                  <div class="text-6xl mb-4 opacity-20">üìÇ</div>
                  <h2 class="text-2xl font-bold text-slate-200 mb-2">Votre collection est vide</h2>
                  <p class="max-w-md mx-auto">
                      Aucun film charg√©. Cliquez sur "Importer JSON".
                  </p>
              </div>
          `;
            document.getElementById('netflixBanner').classList.add('hidden');
            return;
        }

        const banner = document.getElementById('netflixBanner');
        if (currentView === 'netflix' && netflixMovies.length > 0) {
            banner.classList.remove('hidden');
        } else {
            banner.classList.add('hidden');
        }

        const categoriesMap = {};
        netflixMovies.forEach(movie => {
            (movie.categories || []).forEach(cat => {
                if (!categoriesMap[cat]) categoriesMap[cat] = [];
                categoriesMap[cat].push(movie);
            });
        });

        for (const cat in categoriesMap) {
            const section = document.createElement('section');
            section.className = "mb-7 group"; 

            const title = document.createElement('h2');
            title.textContent = cat;
            title.className = "text-xl font-bold mb-3 px-1 flex items-baseline"; 
            section.appendChild(title);

            const wrapper = document.createElement('div');
            wrapper.className = "carousel-wrapper relative";

            const btnLeft = document.createElement('button');
            btnLeft.className = "nav-btn nav-left hidden";
            btnLeft.innerHTML = "&#10094;";
            btnLeft.ariaLabel = "Pr√©c√©dent";
            
            const btnRight = document.createElement('button');
            btnRight.className = "nav-btn nav-right";
            btnRight.innerHTML = "&#10095;";
            btnRight.ariaLabel = "Suivant";

            const carousel = document.createElement('div');
            carousel.className = "carousel flex gap-4 overflow-x-auto scroll-smooth no-scrollbar pb-4 px-1";

            const shuffled = [...categoriesMap[cat]].sort(() => 0.5 - Math.random());
            shuffled.forEach(m => {
                const posterSrc = m.netflixPoster || m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
                
                const card = document.createElement('div');
                card.className = 'carousel-item flex-none w-[160px] md:w-[195px] lg:w-[230px] group/card relative cursor-pointer transition-transform duration-300 hover:scale-105 z-10 hover:z-20';
                
                card.innerHTML = getImageHtml(posterSrc, m.title, "w-full h-auto aspect-video object-cover rounded-md shadow-lg");

                card.addEventListener('click', () => openModal(m));
                carousel.appendChild(card);
            });

            btnLeft.onclick = (e) => { e.stopPropagation(); carousel.scrollLeft -= carousel.clientWidth * 0.90; };
            btnRight.onclick = (e) => { e.stopPropagation(); carousel.scrollLeft += carousel.clientWidth * 0.90; };
            const updateArrows = () => {
                if (carousel.scrollLeft > 20) btnLeft.classList.remove('hidden'); else btnLeft.classList.add('hidden'); // petit fix display ici
                if (carousel.scrollLeft > 20) btnLeft.style.display = 'flex'; else btnLeft.style.display = 'none';
                
                const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                if (carousel.scrollLeft >= maxScroll - 20) btnRight.style.display = 'none'; else btnRight.style.display = 'flex';
            };
            carousel.addEventListener('scroll', updateArrows);
            setTimeout(updateArrows, 100); 

            wrapper.appendChild(btnLeft);
            wrapper.appendChild(carousel);
            wrapper.appendChild(btnRight);
            section.appendChild(wrapper);
            container.appendChild(section);
        }

        if (bannerMovies.length === 0) {
            let candidates = netflixMovies.filter(m => m.netflixPoster || m.poster);
            candidates.sort(() => 0.5 - Math.random());
            bannerMovies = candidates.slice(0, 10);
        }
        
        startBannerAutoScroll(); 
        
         function startBannerAutoScroll() {
          if (bannerInterval) clearInterval(bannerInterval);
          const viewport = document.getElementById('netflixBanner');
          const carousel = document.getElementById('bannerCarousel');
          
          if (!carousel || !viewport) return;
          carousel.innerHTML = '';
          
          const existingDots = viewport.querySelector('.banner-indicators');
          if (existingDots) existingDots.remove();

          const movies = bannerMovies; 
          if (!movies.length) return;

          const indicatorsContainer = document.createElement('div');
          indicatorsContainer.className = 'banner-indicators';
          
          movies.forEach((_, index) => {
              const dot = document.createElement('div');
              dot.className = 'indicator-dot';
              dot.addEventListener('click', (e) => {
                  e.stopPropagation(); 
                  currentIndex = index + 1;
                  updateCarousel(true);
                  restartInterval();
              });
              indicatorsContainer.appendChild(dot);
          });
          viewport.appendChild(indicatorsContainer);
          const dots = Array.from(indicatorsContainer.children);

          function createCard(m) {
            const card = document.createElement('div');
            card.className = 'banner-card';
            
            const duration = m.runtime ? formatRuntime(m.runtime) : '';
            const rating = m.rating ? `‚òÖ ${m.rating}` : '';
            const genres = (m.genres || []).slice(0, 3).join(' ‚Ä¢ ');
            const year = m.year || '';

            card.innerHTML = `
                <img src="${m.netflixPoster || m.poster}" alt="${m.title}" loading="lazy" draggable="false" />
                <div class="banner-gradient"></div>
                <div class="banner-info">
                    <h2 class="text-3xl md:text-5xl font-bold text-white mb-3 drop-shadow-lg leading-tight pointer-events-none">
                        ${escapeHtml(m.title)}
                    </h2>
                    <div class="flex items-center gap-4 text-sm md:text-base font-medium text-slate-200 drop-shadow-md pointer-events-none">
                        ${rating ? `<span class="text-yellow-400 font-bold bg-black/30 px-2 py-0.5 rounded">${rating}</span>` : ''}
                        ${year ? `<span>${year}</span>` : ''}
                        ${duration ? `<span>${duration}</span>` : ''}
                    </div>
                    <div class="mt-2 text-slate-300 text-sm font-medium drop-shadow-md opacity-90 pointer-events-none">
                        ${genres}
                    </div>
                </div>
            `;
            card.addEventListener('click', () => { if (!didMove) openModal(m); });
            return card;
          }

          const lastMovieClone = createCard(movies[movies.length - 1]);
          carousel.appendChild(lastMovieClone);
          movies.forEach(m => { carousel.appendChild(createCard(m)); });
          const firstMovieClone = createCard(movies[0]);
          carousel.appendChild(firstMovieClone);

          const items = Array.from(carousel.querySelectorAll('.banner-card'));
          let currentIndex = 1; 
          let isDragging = false;
          let startPos = 0;
          let currentTranslate = 0;
          let prevTranslate = 0;
          let didMove = false;

          function getPositionX(event) { return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX; }
          function setSliderPosition() { carousel.style.transform = `translateX(${currentTranslate}px)`; }
          function calculateCenterOffset(index) {
            const current = items[index];
            if (!current) return 0;
            const itemOffsetLeft = current.offsetLeft;
            const itemWidth = current.clientWidth;
            const viewportWidth = viewport.clientWidth;
            return -(itemOffsetLeft - (viewportWidth - itemWidth) / 2);
          }

          function updateCarousel(useTransition = true) {
            items.forEach(item => item.classList.remove('active'));
            if(items[currentIndex]) items[currentIndex].classList.add('active');
            dots.forEach(d => d.classList.remove('active'));
            let realIndex = currentIndex - 1;
            if (realIndex < 0) realIndex = movies.length - 1; 
            if (realIndex >= movies.length) realIndex = 0;
            if(dots[realIndex]) dots[realIndex].classList.add('active');
            const targetTranslate = calculateCenterOffset(currentIndex);
            if (useTransition) { carousel.style.transition = 'transform 0.6s cubic-bezier(0.25, 1, 0.5, 1)'; } 
            else { carousel.style.transition = 'none'; }
            currentTranslate = targetTranslate;
            prevTranslate = targetTranslate;
            setSliderPosition();
          }
          
          carousel.addEventListener('transitionend', () => {
             if (currentIndex === 0) { currentIndex = items.length - 2; updateCarousel(false); }
             if (currentIndex === items.length - 1) { currentIndex = 1; updateCarousel(false); }
          });

          function touchStart(event) {
            isDragging = true; didMove = false; startPos = getPositionX(event);
            if (bannerInterval) clearInterval(bannerInterval); 
            carousel.style.transition = 'none';
          }
          function touchMove(event) {
            if (isDragging) {
              const currentPosition = getPositionX(event); const diff = currentPosition - startPos;
              if (Math.abs(diff) > 5) didMove = true;
              currentTranslate = prevTranslate + diff; setSliderPosition();
            }
          }
          function touchEnd() {
            isDragging = false; const movedBy = currentTranslate - prevTranslate;
            if (movedBy < -100) currentIndex += 1; else if (movedBy > 100) currentIndex -= 1;
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= items.length) currentIndex = items.length - 1;
            updateCarousel(true); restartInterval();
          }

          carousel.addEventListener('mousedown', touchStart);
          carousel.addEventListener('touchstart', touchStart, {passive: true});
          carousel.addEventListener('mousemove', touchMove);
          carousel.addEventListener('touchmove', touchMove, {passive: true});
          carousel.addEventListener('mouseup', touchEnd);
          carousel.addEventListener('mouseleave', () => { if(isDragging) touchEnd() });
          carousel.addEventListener('touchend', touchEnd);
          updateCarousel(false); 
          function restartInterval() {
             if (bannerInterval) clearInterval(bannerInterval);
             bannerInterval = setInterval(() => { currentIndex++; updateCarousel(true); }, 6000); 
          }
          restartInterval();
          window.addEventListener('resize', () => { updateCarousel(false); });
        }
    }

   function renderStats() {
     if (!statsView) return;
     statsView.innerHTML = '<h2 class="text-2xl font-semibold mb-4">Stats</h2>';

     const today = new Date();
     const movies = (state.all || []).filter(m => 
       !((m.tags && m.tags.includes('wishlist')) || (m.categories && m.categories.includes('wishlist'))) &&
       !(m.added && new Date(m.added) > today)
     );

     const total = movies.length;
     const totalPrice = movies.reduce((acc, m) => acc + (m.price || 0), 0);
     const totalMarket = movies.reduce((acc, m) => acc + (m.marketValue || 0), 0);
     const seenCount = movies.filter(m => localStorage.getItem('seen_' + m.id)).length;
     
     const genreCounts = {};
     movies.forEach(m => (m.genres||[]).forEach(g => { genreCounts[g] = (genreCounts[g]||0) + 1; }));
     const genresArr = Object.entries(genreCounts).sort((a,b)=>b[1]-a[1]);

     const dirCounts = {};
     movies.forEach(m => (m.directors||[]).forEach(d => { dirCounts[d] = (dirCounts[d]||0) + 1; }));
     const dirArr = Object.entries(dirCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);

     const actorCounts = {};
     movies.forEach(m => (m.people || []).forEach(a => { actorCounts[a] = (actorCounts[a] || 0) + 1; }));
     const actorArr = Object.entries(actorCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

     const countryCounts = {};
     movies.forEach(m => { if (m.country) countryCounts[m.country] = (countryCounts[m.country]||0) + 1; });
     const countryArr = Object.entries(countryCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);

     const durations = movies.map(m => m.runtime || 0).filter(v => v>0);
     const totalMinutes = durations.reduce((s,x)=>s+x,0);
     const avgMinutes = durations.length ? Math.round(totalMinutes/durations.length) : 0;

     const yearCounts = {};
     const decadesCount = {};
     movies.forEach(m => { 
        if (m.year) {
            yearCounts[m.year] = (yearCounts[m.year]||0) + 1; 
            const decade = Math.floor(m.year / 10) * 10;
            decadesCount[decade] = (decadesCount[decade] || 0) + 1;
        }
     });
     const decadesArr = Object.entries(decadesCount).sort((a, b) => a[0] - b[0]);

     const ratingCounts = {};
     for(let i=1; i<=10; i++) ratingCounts[i] = 0;
     movies.forEach(m => {
         if (m.rating) {
             const r = Math.round(m.rating);
             if(ratingCounts[r] !== undefined) ratingCounts[r]++;
         }
     });
     const maxRatingCount = Math.max(...Object.values(ratingCounts)) || 1;

     let shortM = 0, mediumM = 0, longM = 0;
     movies.forEach(m => {
         if(!m.runtime) return;
         if(m.runtime < 100) shortM++;
         else if(m.runtime <= 140) mediumM++;
         else longM++;
     });

     const headerCards = document.createElement('div');
     headerCards.className = 'stats-grid mb-6'; 
     headerCards.innerHTML = `
       <div class="stat-card flex flex-col group hover:bg-white/10 transition-colors">
         <div class="stat-title">Nombre de films dans ma collection</div>
         
         <div class="flex-1 flex items-center justify-center">
            <div class="text-7xl font-black text-white leading-none drop-shadow-xl tracking-tighter">
                ${total}
            </div>
         </div>
       </div>
       <div class="stat-card flex flex-col justify-between">
         <div>
            <div class="flex justify-between items-baseline">
                <div class="stat-title">Valeur Achat</div>
                <div class="text-xs text-green-400 bg-green-400/10 px-2 rounded">Pay√©</div>
            </div>
            <div class="stat-value text-white">${totalPrice.toFixed(2)} ‚Ç¨</div>
         </div>

         <div class="mt-3 pt-3 border-t border-white/10">
            <div class="flex justify-between items-baseline">
                <div class="stat-title">Valeur March√©</div>
                <div class="text-xs text-purple-400 bg-purple-400/10 px-2 rounded">Estim√©</div>
            </div>
            <div class="stat-value text-white">${totalMarket.toFixed(2)} ‚Ç¨</div>
         </div>
         
         <div class="mt-2 text-xs text-slate-400 flex justify-between">
            <span>Moyenne (achat):</span>
            <span class="text-slate-200">${total > 0 ? (totalPrice / total).toFixed(2) : 0} ‚Ç¨</span>
         </div>
       </div>

       <div class="stat-card">
         <div class="stat-title">Films vus / non vus</div>
         <div class="donut" id="seenDonut"></div>
         <div class="donut-center" id="seenCenter">${seenCount}</div>
         </div>
       <div class="stat-card">
         <div class="stat-title">Temps de visionnage</div>
         <div class="stat-value text-blue-400">
            ${Math.floor(totalMinutes / 60)}h ${(totalMinutes % 60).toString().padStart(2, '0')}
         </div>
         
         <div class="stat-title" style="margin-top:.5rem; font-weight:600; font-size:.85rem">Moyenne / film</div>
         <div class="stat-value" style="font-size:1rem">${avgMinutes} min</div>
       </div>
     `;
     statsView.appendChild(headerCards);

     const detailsGrid = document.createElement('div');
     detailsGrid.className = 'stats-grid'; 

     const genreCard = document.createElement('div');
     genreCard.className = 'stat-card';
     genreCard.innerHTML = `<div class="stat-title">R√©partition par genre</div><div id="genreList" class="mt-3"></div>`;
     const genreList = genreCard.querySelector('#genreList');
     
     if (genresArr.length === 0) {
       genreList.innerHTML = '<div class="text-xs opacity-70">Aucun genre trouv√©.</div>';
     } else {
       const max = Math.max(...genresArr.map(([g,c])=>c));
       genresArr.slice(0,8).forEach(([g,c])=>{
         const row = document.createElement('div');
         row.style.display = "flex";
         row.style.alignItems = "center";
         row.style.marginBottom = "6px";
         
         row.innerHTML = `
           <div style="width:110px; min-width:110px; font-size:0.85rem; color:#e6eef8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${g}">
             ${g}
           </div>
           <div style="flex:1; margin: 0 8px; height:10px; background:rgba(255,255,255,0.1); border-radius:99px; overflow:hidden;">
              <div class="bar-fill" style="width:${Math.round((c/max)*100)}%; background: linear-gradient(90deg, #f97316, #ef4444); border-radius:99px;"></div>
           </div>
           <div style="min-width:25px; text-align:right; font-size:0.85rem; color:#cbd5e1; font-weight:bold;">${c}</div>
         `;
         genreList.appendChild(row);
       });
     }
     detailsGrid.appendChild(genreCard);

     const ratingCard = document.createElement('div');
     ratingCard.className = 'stat-card';
     ratingCard.innerHTML = `<div class="stat-title">Notes (√âtoiles)</div><div id="ratingList" class="mt-3"></div>`;
     const ratingList = ratingCard.querySelector('#ratingList');
     for(let r=10; r>=1; r--) {
         const count = ratingCounts[r];
         if (count > 0) {
             ratingList.innerHTML += `
               <div class="genre-bar">
                 <div class="genre-label" style="width:30px; text-align:center;">‚òÖ ${r}</div>
                 <div class="bar">
                    <div class="bar-fill" style="width:${Math.round((count / maxRatingCount) * 100)}%; background: linear-gradient(90deg, #3b82f6, #8b5cf6);"></div>
                 </div>
                 <div style="min-width:30px;text-align:right;font-size:.85rem;color:#cbd5e1">${count}</div>
               </div>
             `;
         }
     }
     detailsGrid.appendChild(ratingCard);

     const dirCard = document.createElement('div');
     dirCard.className = 'stat-card';
     dirCard.innerHTML = `<div class="stat-title">R√©alisateurs fr√©quents</div>`;
     const dirList = document.createElement('div');
     dirList.style.marginTop = '.5rem';
     if (dirArr.length===0) dirList.innerHTML = '<div class="text-xs opacity-70">Aucun r√©alisateur.</div>';
     else dirArr.forEach(([d,c])=> dirList.innerHTML += `<div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">${d} ‚Äî <span style="color:#cbd5e1">${c}</span></div>`);
     dirCard.appendChild(dirList);
     detailsGrid.appendChild(dirCard);

     const actorCard = document.createElement('div');
     actorCard.className = 'stat-card';
     actorCard.innerHTML = `<div class="stat-title">Acteurs fr√©quents</div>`;
     const actorList = document.createElement('div');
     actorList.style.marginTop = '.5rem';
     if (actorArr.length === 0) {
        actorList.innerHTML = '<div class="text-xs opacity-70">Aucun acteur renseign√©.</div>';
     } else {
        actorArr.forEach(([actor, count]) => {
            actorList.innerHTML += `
            <div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">
                ${actor} ‚Äî <span style="color:#cbd5e1">${count}</span>
            </div>`;
        });
     }
     actorCard.appendChild(actorList);
     detailsGrid.appendChild(actorCard);

     const countryCard = document.createElement('div');
     countryCard.className = 'stat-card';
     countryCard.innerHTML = `<div class="stat-title">Pays d'origine</div>`;
     const countryListEl = document.createElement('div');
     countryListEl.style.marginTop = '.5rem';
     if (countryArr.length===0) countryListEl.innerHTML = '<div class="text-xs opacity-70">Aucun pays renseign√©.</div>';
     else countryArr.forEach(([c,cnt]) => countryListEl.innerHTML += `<div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">${c} ‚Äî <span style="color:#cbd5e1">${cnt}</span></div>`);
     countryCard.appendChild(countryListEl);
     detailsGrid.appendChild(countryCard);

     const decadeCard = document.createElement('div');
     decadeCard.className = 'stat-card';
     decadeCard.innerHTML = `<div class="stat-title">Par d√©cennie</div><div class="flex flex-wrap gap-2 mt-3"></div>`;
     const decadeContainer = decadeCard.querySelector('div:last-child');
     decadesArr.forEach(([dec, count]) => {
         decadeContainer.innerHTML += `
            <div class="flex flex-col items-center justify-center bg-white/5 p-2 rounded-lg border border-white/5 min-w-[60px]">
                <span class="text-red-400 font-bold text-xs tracking-wider">${dec}s</span>
                <span class="text-white font-bold">${count}</span>
            </div>
         `;
     });
     detailsGrid.appendChild(decadeCard);

     const runtimeDistCard = document.createElement('div');
     runtimeDistCard.className = 'stat-card';
     runtimeDistCard.innerHTML = `
        <div class="stat-title">Format (Dur√©e)</div>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between items-center text-sm border-b border-white/5 pb-2">
                <span class="text-slate-400">Court (< 1h40)</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${shortM}</span>
            </div>
            <div class="flex justify-between items-center text-sm border-b border-white/5 pb-2">
                <span class="text-slate-400">Standard</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${mediumM}</span>
            </div>
            <div class="flex justify-between items-center text-sm">
                <span class="text-slate-400">Long (> 2h20)</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${longM}</span>
            </div>
        </div>
     `;
     detailsGrid.appendChild(runtimeDistCard);

     let count4k = 0;
     let countBluray = 0;
     let countSteelbook = 0;
     let countAmaray = 0;

     movies.forEach(m => {
         const tags = (m.tags || []).map(t => t.toLowerCase()); 
         if (tags.some(t => t.includes('4k'))) count4k++;
         if (tags.some(t => t.includes('blu-ray') || t.includes('bluray'))) countBluray++;
         if (tags.some(t => t.includes('steelbook'))) countSteelbook++;
         if (tags.some(t => t.includes('amaray'))) countAmaray++;
     });

     const formatCard = document.createElement('div');
     formatCard.className = 'stat-card';
     formatCard.innerHTML = `
        <div class="stat-title">Formats & √âditions</div>
        <div class="grid grid-cols-2 gap-3 mt-3">
            <div class="flex flex-col items-center justify-center bg-black/40 border border-yellow-500/30 p-2 rounded-lg">
                <span class="text-yellow-500 font-bold text-xs uppercase tracking-wider">4K UHD</span>
                <span class="text-white text-xl font-bold">${count4k}</span>
            </div>
            <div class="flex flex-col items-center justify-center bg-blue-900/20 border border-blue-500/30 p-2 rounded-lg">
                <span class="text-blue-400 font-bold text-xs uppercase tracking-wider">Blu-ray</span>
                <span class="text-white text-xl font-bold">${countBluray}</span>
            </div>
            <div class="col-span-2 flex justify-center py-1">
                <div class="h-px bg-white/10 w-3/4 rounded-full"></div>
            </div>
            <div class="flex flex-col items-center justify-center bg-slate-700/40 border border-slate-500/50 p-2 rounded-lg">
                <span class="text-slate-300 font-bold text-xs uppercase tracking-wider">Steelbook</span>
                <span class="text-white text-xl font-bold">${countSteelbook}</span>
            </div>
            <div class="flex flex-col items-center justify-center bg-white/5 border border-white/10 p-2 rounded-lg">
                <span class="text-slate-400 font-bold text-xs uppercase tracking-wider">Amaray</span>
                <span class="text-white text-xl font-bold">${countAmaray}</span>
            </div>
        </div>
     `;
     detailsGrid.appendChild(formatCard);

     statsView.appendChild(detailsGrid);

     const donut = statsView.querySelector('#seenDonut');
     const seenCenterEl = statsView.querySelector('#seenCenter');
     if (donut) {
       const pct = total ? Math.round((seenCount/total)*100) : 0;
       donut.style.background = `conic-gradient(#f97316 0 ${pct}%, #334155 ${pct}% 100%)`;
       if (seenCenterEl) seenCenterEl.textContent = `${pct}%`;
     }

     const currentYear = new Date().getFullYear();
     let addedThisYear = 0;
     let addedLast30Days = 0;
     const thirtyDaysAgo = new Date();
     thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

     movies.forEach(m => {
         if (m.added) {
             const dateAdded = new Date(m.added);
             if (dateAdded.getFullYear() === currentYear) addedThisYear++;
             if (dateAdded >= thirtyDaysAgo) addedLast30Days++;
         }
     });

     const growthCard = document.createElement('div');
     growthCard.className = 'stat-card';
     growthCard.innerHTML = `
        <div class="stat-title">Croissance</div>
        <div class="grid grid-cols-2 gap-4 mt-4 text-center">
            <div class="bg-white/5 rounded-lg p-2 border border-white/5">
                <div class="text-2xl font-bold text-green-400">+${addedLast30Days}</div>
                <div class="text-xs text-slate-400 mt-1">30 jours</div>
            </div>
            <div class="bg-white/5 rounded-lg p-2 border border-white/5">
                <div class="text-2xl font-bold text-blue-400">+${addedThisYear}</div>
                <div class="text-xs text-slate-400 mt-1">En ${currentYear}</div>
            </div>
        </div>
        <div class="mt-4 text-xs text-center text-slate-500">
            Dernier ajout : <span class="text-slate-300">${movies.length ? movies.sort((a,b)=> new Date(b.added)-new Date(a.added))[0].title : 'Aucun'}</span>
        </div>
     `;
     detailsGrid.appendChild(growthCard);

     const monthCounts = Array(12).fill(0);
     const monthNames = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sep", "Oct", "Nov", "D√©c"];
     
     movies.forEach(m => {
         if (m.added) {
             const d = new Date(m.added);
             monthCounts[d.getMonth()]++;
         }
     });
     
     const maxMonth = Math.max(...monthCounts) || 1;

     const seasonCard = document.createElement('div');
     seasonCard.className = 'stat-card';
     seasonCard.innerHTML = `<div class="stat-title">P√©riodes d'ajout</div>`;
     
     const seasonChart = document.createElement('div');
     seasonChart.className = "mt-3 grid grid-cols-6 gap-2"; 
     
     monthNames.forEach((name, index) => {
         const count = monthCounts[index];
         const opacity = 0.2 + (count / maxMonth) * 0.8; 
         seasonChart.innerHTML += `
            <div class="flex flex-col items-center bg-white/5 rounded p-1 border border-white/5">
                <div class="text-[10px] text-slate-400 uppercase">${name}</div>
                <div class="text-sm font-bold text-green-400" style="opacity:${opacity}">${count}</div>
            </div>
         `;
     });
     
     seasonCard.appendChild(seasonChart);
     detailsGrid.appendChild(seasonCard);

     const validMovies = movies.filter(m => m.added);

     const moviesByDate = {};
     validMovies.forEach(m => {
         const dateKey = m.added.substring(0, 10); 
         if (!moviesByDate[dateKey]) moviesByDate[dateKey] = [];
         moviesByDate[dateKey].push(m);
     });

     const sortedDates = Object.keys(moviesByDate).sort((a, b) => new Date(a) - new Date(b));

     if (sortedDates.length > 0) {
        const timelineSection = document.createElement('div');
        timelineSection.className = 'mt-12 mb-12 relative';
        timelineSection.innerHTML = '<h3 class="text-xl font-bold mb-6 px-1">Chronologie des acquisitions</h3>';

        const scrollArea = document.createElement('div');
        scrollArea.className = 'relative w-full overflow-x-auto h-[450px] no-scrollbar flex items-center px-10';

        sortedDates.forEach((dateKey, index) => {
             const groupMovies = moviesByDate[dateKey];
             const dateObj = new Date(dateKey);
             const dateStr = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: '2-digit' });
             
             const isTop = index % 2 === 0;
             const isFirst = index === 0;
             const isLast = index === sortedDates.length - 1;

             const count = groupMovies.length;
             const widthPx = (count * 96) + ((count - 1) * 12) + 32;

             let postersHtml = `<div class="flex items-center gap-3 justify-center">`; 
             groupMovies.forEach(m => {
                 const posterSrc = m.poster || m.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
                 postersHtml += `
                    <div class="poster-trigger relative w-24 aspect-[2/3] rounded-md overflow-hidden bg-white/5 border border-white/10 shadow-xl transition-all duration-300 group hover:scale-110 hover:border-black hover:z-30 cursor-pointer" 
                         data-movie-id="${m.id}">
                         <img src="${posterSrc}" class="w-full h-full object-cover" loading="lazy" />
                         <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-center p-2 bg-gradient-to-t from-black/90 via-black/40 to-transparent">
                            <span class="text-[10px] font-bold text-white text-center leading-tight mb-1 drop-shadow-md">${escapeHtml(m.title)}</span>
                         </div>
                    </div>
                 `;
             });
             postersHtml += `</div>`;

             const item = document.createElement('div');
             item.className = 'relative h-full flex-shrink-0 snap-center flex justify-center px-4';
             item.style.width = `${widthPx}px`;

             const hLine = document.createElement('div');
             let hLineClasses = 'absolute top-1/2 h-0.5 bg-white/30 z-0';
             
             if (sortedDates.length > 1) { 
                 if (isFirst) {
                     hLineClasses += ' left-1/2 w-1/2'; 
                 } else if (isLast) {
                     hLineClasses += ' left-0 w-1/2';
                 } else {
                     hLineClasses += ' left-0 w-full';
                 }
                 hLine.className = hLineClasses;
                 item.appendChild(hLine);
             }

             const dot = document.createElement('div');
             dot.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-slate-200 border-2 border-[#1a1a1a] z-20 shadow-lg`;
             
             const stem = document.createElement('div');
             stem.className = `absolute left-1/2 -translate-x-1/2 w-0.5 bg-white/30 h-10 z-0 ${isTop ? 'bottom-1/2' : 'top-1/2'}`;

             const contentBox = document.createElement('div');
             contentBox.className = `absolute left-1/2 -translate-x-1/2 flex flex-col items-center w-max ${isTop ? 'bottom-[calc(50%+2.5rem)]' : 'top-[calc(50%+2.5rem)]'}`;
             
             const dateBadge = `<div class="text-[11px] font-mono text-slate-300 font-bold bg-black/60 px-2 py-0.5 rounded-full border border-white/20 backdrop-blur-sm mb-2 shadow-sm whitespace-nowrap">${dateStr}</div>`;

             if (isTop) {
                 contentBox.innerHTML = `
                    <div class="mb-1">${postersHtml}</div>
                    ${dateBadge}
                 `;
             } else {
                 contentBox.innerHTML = `
                    ${dateBadge}
                    <div class="mt-1">${postersHtml}</div>
                 `;
             }

             item.appendChild(stem);
             item.appendChild(dot);
             item.appendChild(contentBox);
             
             const posterElements = item.querySelectorAll('.poster-trigger');
             posterElements.forEach((el, idx) => {
                 el.onclick = (e) => {
                     e.stopPropagation();
                     const movieToOpen = groupMovies[idx]; 
                     openModal(movieToOpen);
                 };
             });

             scrollArea.appendChild(item);
        });

        timelineSection.appendChild(scrollArea);
        statsView.appendChild(timelineSection);
        
        setTimeout(() => { 
            scrollArea.scrollLeft = scrollArea.scrollWidth; 
        }, 300);
     }
   }

   function initFuse() {
        const options = {
            includeScore: true,
            threshold: 0.3, // 0 = correspondance parfaite, 1 = correspond √† tout. 0.3 est un bon √©quilibre.
            keys: [
                { name: 'title', weight: 0.7 },      // Le titre est prioritaire
                { name: 'directors', weight: 0.3 },  // Ensuite les r√©alisateurs
                { name: 'people', weight: 0.3 },     // Puis les acteurs
                { name: 'tags', weight: 0.2 }        // Et les tags
            ]
        };
        fuse = new Fuse(state.all, options);
    }

    function renderGrid() {
     els.grid.innerHTML = '';
     let countText = `${state.filtered.length} film${state.filtered.length > 1 ? 's' : ''}`;
     els.count.textContent = countText;

     for (const m of state.filtered) {
       const posterSrc = m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;

       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3]">
           ${getImageHtml(posterSrc, m.title, "w-full h-full object-cover rounded-lg group-hover:scale-105 transition-transform duration-300")}
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
           <div class="flex flex-wrap gap-1 pt-1">
             ${(m.genres||[]).slice(0,3).map(g => `<span class='text-[10px] px-1.5 py-0.5 rounded-full bg-white/10'>${escapeHtml(g)}</span>`).join('')}
           </div>
          </div>
        `;
       card.addEventListener('click', () => openModal(m));
       els.grid.appendChild(card);
      }
    }

    function renderUpcomingView() {
     const container = document.getElementById('upcomingView');
     container.innerHTML = '';

     const today = new Date();
     const upcomingMovies = state.all
       .filter(m => {
         const isFuture = m.added && new Date(m.added) > today;
         const isWishlist = (m.categories && m.categories.includes('wishlist')) || 
                            (m.tags && m.tags.includes('wishlist'));
         return isFuture && !isWishlist; 
       })
       .sort((a, b) => new Date(a.added) - new Date(b.added));

     if (upcomingMovies.length === 0) {
       container.innerHTML = '<p class="text-slate-200">Aucun film √† venir pour le moment.</p>';
       return;
     }

     const grid = document.createElement('div');
     grid.className = 'grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6';

     upcomingMovies.forEach(m => {
       const posterSrc = m.poster || m.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
    
       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3] bg-black/40">
           ${getImageHtml(posterSrc, m.title, "w-full h-full object-cover rounded-lg group-hover:scale-105 transition-transform duration-300")}
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
         </div>
        `;
       card.addEventListener('click', () => openModal(m));
        grid.appendChild(card);
     });

     container.appendChild(grid);
   }
    
    function renderWishlistView() {
     const container = document.getElementById('wishlistView');
     container.innerHTML = '';

     const wishlistMovies = state.all.filter(m => 
       (m.tags && m.tags.includes('wishlist')) || 
       (m.categories && m.categories.includes('wishlist'))
     ).sort((a, b) => a.title.localeCompare(b.title));

     if (wishlistMovies.length === 0) {
       container.innerHTML = '<p class="text-slate-200">Aucun film dans la wishlist.</p>';
       return;
     }

     const grid = document.createElement('div');
     grid.className = 'grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6';

     wishlistMovies.forEach(m => {
       const posterSrc = m.poster || m.netflixPoster || 
         `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;

       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3] bg-black/40">
           ${getImageHtml(posterSrc, m.title, "w-full h-full object-cover rounded-lg group-hover:scale-105 transition-transform duration-300")}
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
         </div>
       `;
       card.addEventListener('click', () => openModal(m));
       grid.appendChild(card);
     });

     container.appendChild(grid);
   }

    function formatRuntime(minutes) {
     if (!minutes) return "Dur√©e inconnue";
     const h = Math.floor(minutes / 60);
     const m = minutes % 60;
     return `${h}h${m.toString().padStart(2,"0")}`;
    }

    function formatAddedDate(dateString) {
     if (!dateString) return '';
     try {
       const date = new Date(dateString);
       return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
     } catch (e) {
       return dateString;
     }
    }

    function placeholderSVG(text){
      const bg = '#0f172a';
      const fg = '#94a3b8';
      return `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='600'>
        <rect width='100%' height='100%' fill='${bg}'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='${fg}' font-family='system-ui,Segoe UI,Arial' font-size='22'>${(text||'Poster')}</text>
      </svg>`;
    }

    function getImageHtml(src, title, cssClass = "w-full h-full object-cover") {
      return `
        <div class="img-loader-container w-full h-full rounded-md">
            <div class="loading-spinner"></div>
            <img src="${src}" 
                 alt="${escapeHtml(title)}" 
                 loading="lazy" 
                 class="${cssClass} relative z-10 opacity-0 transition-opacity duration-500"
                 onload="this.classList.remove('opacity-0')"
                 onerror="this.parentElement.innerHTML='<div class=\'text-xs text-slate-500 p-2 text-center\'>Image non dispo</div>'"
            />
        </div>
      `;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function openModal(m) {
     const content = document.getElementById('modalContent');
     if (!content) return;

     let showingAlt = false;
     const mainPoster = m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
     const altPoster = m.altPoster || null;

     els.modalPoster.src = mainPoster;
     els.modalTitle.textContent = m.title;

     const metaHtml = [
       m.year ? `<span>${m.year}</span>` : '',
       m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : '',
       m.rating ? `<span>‚Ä¢ ‚òÖ ${m.rating}</span>` : ''
     ];

     if (m.added) {
       metaHtml.push(`<span>‚Ä¢ Ajout√© le ${formatAddedDate(m.added)}</span>`);
     }
     els.modalMeta.innerHTML = metaHtml.join(' ');

     const specs = m.technicalSpecs || {};
     const audioStr = (specs.audio || '').toLowerCase();
     const hdrStr = (specs.hdr || '').toLowerCase();
     let badgesHtml = '';

     const urlDolbyVision = "https://upload.wikimedia.org/wikipedia/commons/0/03/Dolby_Vision_2021_logo.svg";
     const urlDolbyAtmos = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Logo_Dolby_Atmos.svg/2560px-Logo_Dolby_Atmos.svg.png";
     const urlDtsHd = "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/DTS-HD-MA.svg/2560px-DTS-HD-MA.svg.png";
     const urlDtsX = "https://leclaireur.fnac.com/wp-content/uploads/2022/12/dts-x-logo-1024x298.png";
     const urlHdr10 = "https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/HDR_10_logo_%28black%29.svg/1280px-HDR_10_logo_%28black%29.svg.png";

     if (hdrStr.includes('vision') || hdrStr.includes('dv')) {
         badgesHtml += `
           <img src="${urlDolbyVision}" 
                alt="Dolby Vision" 
                class="h-4 w-auto object-contain invert opacity-90 select-none" 
                title="Dolby Vision" />
         `;
      } 
     else if (hdrStr.includes('hdr10') || hdrStr.includes('hdr 10')) {
         badgesHtml += `
           <img src="${urlHdr10}" 
                alt="HDR10" 
                class="h-4 w-auto object-contain invert opacity-90 select-none" 
                title="HDR10" />
         `;
     }

     if (audioStr.includes('atmos')) {
         badgesHtml += `
           <img src="${urlDolbyAtmos}" 
                alt="Dolby Atmos" 
                class="h-4 w-auto object-contain invert opacity-90 select-none" 
                title="Dolby Atmos" />
         `;
     }

     if (audioStr.includes('dts:x') || audioStr.includes('dts x')) {
         badgesHtml += `
           <img src="${urlDtsX}" 
                alt="DTS:X" 
                class="h-3.5 w-auto object-contain invert opacity-90 select-none" 
                title="DTS:X" />
         `;
     }

     if (audioStr.includes('dts-hd') || audioStr.includes('dts hd') || audioStr.includes('master audio')) {
         badgesHtml += `
           <img src="${urlDtsHd}" 
                alt="DTS-HD Master Audio" 
                class="h-5 w-auto object-contain invert opacity-90 select-none" 
                title="DTS-HD Master Audio" />
         `;
     }

     if (els.modalTechBadges) {
         els.modalTechBadges.innerHTML = badgesHtml;
         
         if (badgesHtml.trim() === '') {
             els.modalTechBadges.classList.add('hidden');
             els.modalTechBadges.classList.remove('flex', 'h-6', 'mt-1');
         } else {
             els.modalTechBadges.classList.remove('hidden');
             els.modalTechBadges.classList.add('flex', 'h-6', 'mt-1');
         }
     }

     function switchTab(tabId) {
         els.tabOverviewBtn.classList.remove('border-red-600', 'text-red-400');
         els.tabSpecsBtn.classList.remove('border-red-600', 'text-red-400');
         
         els.tabOverviewBtn.classList.add('border-transparent', 'text-slate-400', 'hover:text-white');
         els.tabSpecsBtn.classList.add('border-transparent', 'text-slate-400', 'hover:text-white');

         els.contentOverview.classList.add('hidden');
         els.contentSpecs.classList.add('hidden');

         if (tabId === 'overview') {
             els.tabOverviewBtn.classList.remove('border-transparent', 'text-slate-400', 'hover:text-white');
             els.tabOverviewBtn.classList.add('border-red-600', 'text-red-400');
             els.contentOverview.classList.remove('hidden');
         } else if (tabId === 'specs') {
             els.tabSpecsBtn.classList.remove('border-transparent', 'text-slate-400', 'hover:text-white');
             els.tabSpecsBtn.classList.add('border-red-600', 'text-red-400');
             els.contentSpecs.classList.remove('hidden');
         }
     }
     
     switchTab('overview');
     els.tabOverviewBtn.onclick = () => switchTab('overview');
     els.tabSpecsBtn.onclick = () => switchTab('specs');

     els.modalOverview.textContent = m.overview || '';
     
     if (m.directors && m.directors.length) {
       els.modalDirectors.innerHTML = '<span class="text-slate-500">R√©alisation : </span>' + 
         m.directors.map(d => `<span class="director-link text-red-400 hover:underline cursor-pointer font-medium">${d}</span>`).join(', ');
     } else {
       els.modalDirectors.innerHTML = '';
     }

     if (m.people && m.people.length) {
       els.modalActors.innerHTML = m.people.map(actor => `<span class="actor-link text-red-400 hover:underline cursor-pointer">${actor}</span>`).join(', ');
     } else {
       els.modalActors.textContent = '';
     }

     els.modalCountry.innerHTML = m.country ? `Pays d'origine : ${escapeHtml(m.country)}` : '';
     els.modalTags.innerHTML = (m.tags || []).map(t => 
       `<span class='tag-link text-xs px-2 py-1 rounded-full bg-white/10 hover:bg-red-600 transition cursor-pointer'>${escapeHtml(t)}</span>`
     ).join('');
     
     els.specsGrid.innerHTML = '';
     
     const priceVal = m.price ? Number(m.price).toFixed(2) + ' ‚Ç¨' : null;
     const marketVal = m.marketValue ? Number(m.marketValue).toFixed(2) + ' ‚Ç¨' : null;

     const specsData = [
         { title: "Master", value: specs.resolution, icon: "üì∫" },
         { title: "Format HDR", value: specs.hdr, icon: "‚ú®" },
         { title: "Bitrate", value: specs.bitrate, icon: "üìä" },
         { title: "Format Audio VO", value: specs.audio, icon: "üîä" },
         { title: "Type de Disque", value: specs.diskType, icon: "üíø" },
         { title: "Format Image", value: specs.aspectRatio, icon: "üñºÔ∏è" },
         { title: "Prix d'achat", value: priceVal, icon: "üè∑Ô∏è", color: "text-green-400" },
         { title: "Estimation", value: marketVal, icon: "üìà", color: "text-purple-400" }
     ];

     let hasSpecs = false;
     specsData.forEach(item => {
         if (item.value) {
             hasSpecs = true;
             const valueColor = item.color ? item.color : "text-white";
             els.specsGrid.innerHTML += `
                 <div class="p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition">
                     <div class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-1 flex items-center gap-2">
                         ${item.icon} ${item.title}
                     </div>
                     <div class="text-lg font-bold ${valueColor}">${escapeHtml(item.value)}</div>
                 </div>
             `;
         }
     });

     if (!hasSpecs) {
         els.specsGrid.innerHTML = '<p class="text-slate-400 col-span-full">Aucune information technique ou tarifaire renseign√©e.</p>';
     }

     const lowerTags = (m.tags || []).map(t => t.toLowerCase());
     const isSteelbook = lowerTags.some(t => t.includes('steelbook'));

     let searchQuery;
     let searchTypeLabel;

     if (m.ean) {
         searchQuery = m.ean;
         searchTypeLabel = `Recherche pr√©cise via EAN : ${m.ean}`;
     } else {
         const suffix = isSteelbook ? 'steelbook' : 'blu-ray';
         searchQuery = `${m.title} ${suffix}`;
         searchTypeLabel = `Recherche via Titre (${isSteelbook ? '√âdition Steelbook' : '√âdition Standard'})`;
     }

     const q = encodeURIComponent(searchQuery);

     const linksHtml = `
        <div class="col-span-full mt-4 pt-4 border-t border-white/10 animate-fade-in">
            <h4 class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-3 flex items-center gap-2">
                üîé Trouver ce film ${isSteelbook ? '<span class="text-amber-500 text-[10px] border border-amber-500/30 px-1 rounded">STEELBOOK</span>' : ''}
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                
                <a href="https://www.fnac.com/SearchResult/ResultList.aspx?Search=${q}" 
                   target="_blank"
                   class="flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-[#eab308]/10 text-[#eab308] border border-[#eab308]/20 hover:bg-[#eab308] hover:text-black transition-all font-bold text-sm group">
                   <span>Fnac</span>
                   <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>

                <a href="https://www.amazon.fr/s?k=${q}" 
                   target="_blank"
                   class="flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-[#f97316]/10 text-[#f97316] border border-[#f97316]/20 hover:bg-[#f97316] hover:text-white transition-all font-bold text-sm group">
                   <span>Amazon</span>
                   <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>

                <a href="https://www.vinted.fr/catalog?search_text=${q}" 
                   target="_blank"
                   class="flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-[#06b6d4]/10 text-[#06b6d4] border border-[#06b6d4]/20 hover:bg-[#06b6d4] hover:text-white transition-all font-bold text-sm group">
                   <span>Vinted</span>
                   <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>

            </div>
            <div class="mt-2 text-[10px] text-slate-500 text-center">
                ${searchTypeLabel}
            </div>
        </div>
     `;
     
     els.specsGrid.innerHTML += linksHtml;
     // --- FIN DU COMPARATEUR ---

     const actionsContainer = document.getElementById('modalActionsContainer');
     actionsContainer.innerHTML = ''; 
     
     const userActionsWrapper = document.createElement('div');
     userActionsWrapper.className = "flex flex-wrap items-center gap-4";

     let userRating = localStorage.getItem("myrating_" + m.id) || "";
     const ratingHTML = `
       <div class="flex items-center gap-2 text-sm">
         <span class="opacity-80">Ma note :</span>
         <select id="userRatingSelect" class="px-2 py-1 rounded bg-white/10 text-slate-900 md:text-white border border-white/10 focus:bg-slate-800 outline-none cursor-pointer hover:bg-white/20 transition">
           <option value="">‚Äì</option>
           ${[...Array(10)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
         </select>
       </div>
     `;

     const isSeen = localStorage.getItem('seen_' + m.id);
     const seenBtnHtml = document.createElement('button');
     seenBtnHtml.className = "px-4 py-1 rounded-full border border-white/10 text-xs font-semibold transition-all hover:bg-white/20 flex items-center gap-2";

     const updateSeenBtn = (active) => {
         if (active) {
             seenBtnHtml.classList.add('bg-green-500/20', 'text-green-400', 'border-green-500/30');
             seenBtnHtml.innerHTML = "<span>üëÅÔ∏è</span> Visionn√©";
         } else {
             seenBtnHtml.classList.remove('bg-green-500/20', 'text-green-400', 'border-green-500/30');
             seenBtnHtml.innerHTML = "<span class='opacity-50'>‚≠ï</span> Non visionn√©";
         }
     };
     updateSeenBtn(isSeen); 

     seenBtnHtml.onclick = () => {
         if (localStorage.getItem('seen_' + m.id)) {
             localStorage.removeItem('seen_' + m.id);
             updateSeenBtn(false);
         } else {
             localStorage.setItem('seen_' + m.id, 'true');
             updateSeenBtn(true);
         }
         applyFilters(); 
     };

     userActionsWrapper.innerHTML = ratingHTML;
     userActionsWrapper.appendChild(seenBtnHtml);
     actionsContainer.appendChild(userActionsWrapper);

     const selectRating = document.getElementById("userRatingSelect");
     if(selectRating) {
         selectRating.value = userRating;
         selectRating.addEventListener("change", () => {
           if (selectRating.value === "") localStorage.removeItem("myrating_" + m.id);
           else localStorage.setItem("myrating_" + m.id, selectRating.value);
         });
     }

     const navigateToSearch = (e) => {
         e.stopPropagation();
         state.query = e.target.textContent.trim();
         els.search.value = state.query;
         currentView = 'grid';
         setActiveTab('grid');
         hideAllViews();
         document.getElementById('gridView').classList.remove('hidden');
         applyFilters();
         closeModal();
     };

     els.modalDirectors.querySelectorAll('.director-link').forEach(el => el.addEventListener('click', navigateToSearch));
     els.modalActors.querySelectorAll('.actor-link').forEach(el => el.addEventListener('click', navigateToSearch));
     els.modalTags.querySelectorAll('.tag-link').forEach(el => el.addEventListener('click', navigateToSearch));

     const posterWrapper = els.modalPoster.parentElement; 
     
     const oldBtn = posterWrapper.querySelector('.switchPosterBtn');
     if (oldBtn) oldBtn.remove();

     if (altPoster) {
       const switchBtn = document.createElement('button');
       switchBtn.className = "switchPosterBtn absolute bottom-2 right-2 bg-black/70 backdrop-blur-md text-white w-8 h-8 flex items-center justify-center rounded-full z-20 hover:bg-red-600 transition shadow-lg border border-white/20";
       switchBtn.innerHTML = '<span class="text-xs">‚Üª</span>'; // Icone de rotation simple
       
       posterWrapper.appendChild(switchBtn);

       switchBtn.addEventListener('click', (e) => {
         e.stopPropagation(); // Emp√™che de fermer la modale si on clique mal
         if (showingAlt) {
           els.modalPoster.src = mainPoster;
           switchBtn.classList.remove("text-red-400");
         } else {
           els.modalPoster.src = altPoster;
           switchBtn.classList.add("text-red-400"); // Indicateur visuel
         }
         showingAlt = !showingAlt;
       });
     }

     els.modal.classList.remove('hidden');
     content.classList.remove('scale-100','opacity-100');
     content.classList.add('scale-95','opacity-0');

     requestAnimationFrame(() => {
       content.classList.remove('scale-95','opacity-0');
       content.classList.add('scale-100','opacity-100');
     });
    } // FIN DE openModal (ne pas effacer cette accolade !)

    function closeModal() {
     const content = document.getElementById('modalContent');
     content.classList.remove('scale-100', 'opacity-100');
     content.classList.add('scale-95', 'opacity-0');

     setTimeout(() => {
       els.modal.classList.add('hidden');
     }, 200);
    }

   function hideAllViews() {
     document.getElementById('mainView').classList.add('hidden');
     document.getElementById('gridView').classList.add('hidden');
     document.getElementById('upcomingView').classList.add('hidden');
     document.getElementById('wishlistView').classList.add('hidden');
     document.getElementById('statsView').classList.add('hidden');
     document.getElementById('bingoView').classList.add('hidden');
   }

   document.getElementById('tabUpcoming').addEventListener('click', () => {
     currentView = 'upcoming';
     setActiveTab('upcoming');
     hideAllViews();
     document.getElementById('upcomingView').classList.remove('hidden');
     applyFilters();
   });

   document.getElementById('tabWishlist').addEventListener('click', () => {
     currentView = 'wishlist';
     setActiveTab('wishlist');
     hideAllViews();
     document.getElementById('wishlistView').classList.remove('hidden');
     applyFilters();
   });

   tabStatsBtn.addEventListener('click', () => {
     currentView = 'stats';
     setActiveTab('stats');
     hideAllViews();
     statsView.classList.remove('hidden');
     renderStats();
   });

    els.search.addEventListener('input', e=>{ state.query = e.target.value; applyFilters(); });
    els.genre.addEventListener('change', e=>{ state.genre = e.target.value; applyFilters(); });
    els.yearExact.addEventListener('input', e=>{ state.yearExact = e.target.value; applyFilters(); });
    els.runtime.addEventListener('change', e =>{ state.runtime = e.target.value; applyFilters(); });
    els.sort.addEventListener('change', e=>{ state.sort = e.target.value; applyFilters(); });
    els.country.addEventListener('change', e => {state.country = e.target.value; applyFilters(); });
    els.period.addEventListener('change', e => {state.period = e.target.value; applyFilters(); });
    els.seen.addEventListener('change', e => { state.seen = e.target.value; applyFilters(); });
    
    els.reset.addEventListener('click', ()=>{
        resetFilters();
    });    

    els.randomBtn.addEventListener('click', () => {
        if (state.filtered.length === 0) {
            alert("Aucun film trouv√© dans la s√©lection actuelle !");
            return;
        }

        const overlay = document.getElementById('randomRoulette');
        const rPoster = document.getElementById('roulettePoster');
        const rTitle = document.getElementById('rouletteTitle');
        
        overlay.classList.remove('hidden');
        overlay.classList.remove('opacity-0');
        rPoster.parentElement.classList.remove('shake-effect');

        let duration = 0;
        let speed = 50; 
        let maxDuration = 2000; 
        let shuffles = 0;
        let lastIndex = -1;

        const shuffle = () => {
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * state.filtered.length);
            } while (randomIndex === lastIndex && state.filtered.length > 1);
            
            lastIndex = randomIndex;
            const movie = state.filtered[randomIndex];

            rPoster.src = movie.poster || movie.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(movie.title))}`;
            rTitle.textContent = movie.title;
            
            duration += speed;
            shuffles++;

            if (duration < maxDuration) {
                if (duration > maxDuration * 0.7) speed += 20; 
                setTimeout(shuffle, speed);
            } else {
                finish(movie);
            }
        };

        const finish = (movie) => {
            rTitle.textContent = "üé¨ " + movie.title;
            rTitle.classList.remove('animate-pulse');
            rTitle.classList.add('text-green-400');
            
            const wrapper = rPoster.parentElement;
            
            wrapper.classList.remove('shake-effect');
            void wrapper.offsetWidth; 
            wrapper.classList.add('shake-effect');

            wrapper.classList.remove('ring-white/5');
            wrapper.classList.add('ring-green-500');

            setTimeout(() => {
                overlay.classList.add('opacity-0');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    rTitle.classList.add('animate-pulse');
                    rTitle.classList.remove('text-green-400');
                    
                    wrapper.classList.remove('shake-effect'); 
                    wrapper.classList.remove('ring-green-500');
                    wrapper.classList.add('ring-white/5');
                    
                    openModal(movie);
                }, 500); 
            }, 1200);
        };

        shuffle();
    });

    els.modalClose.addEventListener('click', closeModal);
    els.modalBackdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
     if (e.key === 'Escape' && !els.modal.classList.contains('hidden')) {
      closeModal();
     }
    });

    els.sortDirBtn.addEventListener('click', ()=>{ 
     state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
     els.sortDirBtn.textContent = state.sortDir === "asc" ? "‚¨ÜÔ∏é" : "‚¨áÔ∏é";
     applyFilters();
    });

    els.jsonFile.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        let text = await file.text();
        
        text = text.trim();
        const lastBrace = text.lastIndexOf('}');
        if (lastBrace !== -1 && lastBrace < text.length - 1) {
            text = text.substring(0, lastBrace + 1);
        }

        const parsed = JSON.parse(text);
        if(!parsed.movies || !Array.isArray(parsed.movies)) throw new Error('Sch√©ma invalide');
        
        bannerMovies = [];
        state.all = normalize(parsed.movies);
        initFuse();
        initFilters();
        resetFilters();
        
        alert("Collection import√©e avec succ√®s : " + state.all.length + " films.");
        
      } catch(err){
        console.error(err);
        alert('Impossible de lire ce JSON. V√©rifiez le format du fichier.');
      }
    });

   document.getElementById('tabMain').addEventListener('click', () => {
     currentView = 'netflix';
     setActiveTab('netflix');
     hideAllViews();
     document.getElementById('mainView').classList.remove('hidden');
     renderNetflixView();
   });

   document.getElementById('tabGrid').addEventListener('click', () => {
      currentView = 'grid';
      setActiveTab('grid');
      hideAllViews();
      document.getElementById('gridView').classList.remove('hidden');
      
      if (filterInputsContainer) {
          if (toggleFiltersBtn) toggleFiltersBtn.textContent = filterInputsContainer.classList.contains('hidden') ? "Afficher les filtres & tri" : "Masquer les filtres & tri";
      }
      applyFilters();
    });

   const tabBingoBtn = document.getElementById('tabBingo');
   const bingoView = document.getElementById('bingoView');
   const bingoModal = document.getElementById('bingoModal');
   const bingoContent = document.getElementById('bingoContent');
   
   const referenceFilmographies = {
       "Christopher Nolan": ["Following", "Memento", "Insomnia", "Batman Begins", "Le Prestige", "The Dark Knight", "Inception", "The Dark Knight Rises", "Interstellar", "Dunkerque", "Tenet", "Oppenheimer"],
       "Quentin Tarantino": ["Reservoir Dogs", "Pulp Fiction", "Jackie Brown", "Kill Bill: Volume I", "Kill Bill: Volume II", "Boulevard de la mort", "Inglourious Basterds", "Django Unchained", "Les 8 Salopards", "Once Upon a Time in... Hollywood"],
       "Denis Villeneuve": ["Polytechnique", "Incendies", "Prisoners", "Enemy", "Sicario", "Premier Contact", "Blade Runner 2049", "Dune : Premi√®re Partie", "Dune : Deuxi√®me Partie"],
       "David Fincher": ["Alien 3", "Seven", "The Game", "Fight Club", "Panic Room", "Zodiac", "L'√âtrange Histoire de Benjamin Button", "The Social Network", "Mill√©nium : Les Hommes qui n'aimaient pas les femmes", "Gone Girl", "Mank", "The Killer"],
       "Stanley Kubrick": ["L'Ultime Razzia", "Les Sentiers de la gloire", "Spartacus", "Lolita", "Dr. Folamour", "2001 : L'Odyss√©e de l'espace", "Orange m√©canique", "Barry Lyndon", "Shining", "Full Metal Jacket", "Eyes Wide Shut"],
       "Steven Spielberg": ["Les Dents de la mer", "Rencontres du troisi√®me type", "Les Aventuriers de l'arche perdue", "E.T., l'extra-terrestre", "Indiana Jones et le Temple maudit", "La Couleur pourpre", "Empire du soleil", "Indiana Jones et la Derni√®re Croisade", "Hook ou la Revanche du capitaine Crochet", "Jurassic Park", "La Liste de Schindler", "Le Monde perdu : Jurassic Park", "Amistad", "Il faut sauver le soldat Ryan", "A.I. Intelligence artificielle", "Minority Report", "Arr√™te-moi si tu peux", "Le Terminal", "La Guerre des mondes", "Munich", "Indiana Jones et le Royaume du cr√¢ne de cristal", "Les Aventures de Tintin : Le Secret de la Licorne", "Cheval de guerre", "Lincoln", "Le Pont des espions", "Le BGG : Le Bon Gros G√©ant", "Pentagon Papers", "Ready Player One", "West Side Story", "The Fabelmans"],
       "James Cameron": ["Terminator", "Aliens, le retour", "Abyss", "Terminator 2 : Le Jugement dernier", "True Lies", "Titanic", "Avatar", "Avatar : La Voie de l'eau", "Avatar: De feu et de cendres"],
       "Martin Scorsese": ["Mean Streets", "Taxi Driver", "Raging Bull", "After Hours: Quelle nuit de gal√®re", "La Couleur de l'argent", "La Derni√®re Tentation du Christ", "Les Affranchis", "Les Nerfs √† Vif", "Le Temps de l'innocence", "Casino", "√Ä tombeau ouvert", "Gangs of New York", "Aviator", "Les Infiltr√©s", "Shutter Island", "Hugo Cabret", "Le Loup de Wall Street", "Silence", "The Irishman", "Killers of the Flower Moon"],
       "Paul Thomas Anderson": ["Double Mise", "Boogie Nights", "Magnolia", "Punch-Drunk Love", "There Will Be Blood", "The Master", "Inherent Vice", "Phantom Thread", "Licorice Pizza", "Une bataille apr√®s l'autre"],
       "Ridley Scott": ["Alien", "Blade Runner", "Legend", "Black Rain", "Thelma & Louise", "Gladiator", "Hannibal", "La Chute du faucon noir", "Les Associ√©s", "Kingdom of Heaven", "Une grande ann√©e", "American Gangster", "Mensonges d'√©tat", "Robin des Bois", "Prometheus", "Cartel", "Exodus : Gods and Kings", "Seul sur Mars", "Alien : Covenant", "Tout l'argent du monde", "Le Dernier Duel", "House of Gucci", "Napol√©on", "Gladiator II"],
       "Damien Chazelle": ["Whiplash", "La La Land", "First Man", "Babylon"],
       "Tim Burton": ["Pee-wee Big Adventure", "Beetlejuice", "Batman", "Edward aux mains d'argent", "Batman : Le D√©fi", "Ed Wood", "Mars Attacks!", "Sleepy Hollow", "La plan√®te des singes", "Big Fish", "Charlie et la Chocolaterie", "Les Noces fun√®bres", "Sweeney Todd", "Alice au pays des merveilles", "Dark Shadows", "Frankenweenie", "Big Eyes", "Miss Peregrine et les Enfants particuliers", "Dumbo", "Beetlejuice Beetlejuice"],
       "Robert Zemeckis": ["√Ä la poursuite du diamant vert", "Retour vers le futur", "Qui veut la peau de Roger Rabbit", "Retour vers le futur 2", "Retour vers le futur 3", "La mort vous va si bien", "Forrest Gump", "Contact", "Apparences", "Seul au monde", "Le P√¥le Express", "La l√©gende de Beowulf", "Le dr√¥le de No√´l de Scrooge", "Flight", "The Walk", "Alli√©s", "Bienvenue √† Marwen", "Sacr√©es sorci√®res", "Pinocchio", "Here"],
       "Sam Mendes": ["American Beauty", "Les sentiers de la perdition", "Jarhead : La fin de l'innocence", "Les noces rebelles", "Away We Go", "Skyfall", "Spectre", "1917", "Empire of Light"],
       "Frank Darabont": ["Les √âvad√©s", "La Ligne verte", "The Majestic", "The Mist"],
       "Rian Johnson": ["Brick", "Une arnaque presque parfaite", "Looper", "Star Wars, √©pisode VIII : Les Derniers Jedi", "√Ä couteaux tir√©s", "Glass Onion", "Wake Up Dead Man"],
       "Francis Ford Coppola": ["Le Parrain", "Conversation Secr√®te", "Le Parrain, 2√®me partie", "Apocalypse Now", "Outsiders", "Le Parrain, 3√®me partie", "Dracula", "Jack", "L'Id√©aliste", "Megalopolis"],
       "Ari Aster": ["H√©r√©dit√©", "Midsommar", "Beau is Afraid", "Eddington"]
   };

   const directorPhotos = {
       "Christopher Nolan": "https://media.themoviedb.org/t/p/w440_and_h660_face/62gmVhxnamAtZkhVWw1t2QHK9dL.jpg",
       "Quentin Tarantino": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Quentin_Tarantino_by_Gage_Skidmore.jpg/440px-Quentin_Tarantino_by_Gage_Skidmore.jpg",
       "Denis Villeneuve": "https://media.themoviedb.org/t/p/w440_and_h660_face/c9vs3EJpx555US89I975csyf5js.jpg",
       "David Fincher": "https://media.themoviedb.org/t/p/w440_and_h660_face/xwGXpxDugyTVE422aDeIy9WzpXu.jpg",
       "Stanley Kubrick": "https://media.themoviedb.org/t/p/w440_and_h660_face/yFT0VyIelI9aegZrsAwOG5iVP4v.jpg",
       "Steven Spielberg": "https://media.themoviedb.org/t/p/w440_and_h660_face/8RlUJCqmZGKeeaBarul4ZoUWcHG.jpg",
       "James Cameron": "https://media.themoviedb.org/t/p/w440_and_h660_face/2Hh4Jos62luf90CCglP5K32qaWO.jpg",
       "Martin Scorsese": "https://media.themoviedb.org/t/p/w440_and_h660_face/4Xwx5XL1RJj0JQmEo8Fhr6nkpOg.jpg",
       "Paul Thomas Anderson": "https://media.themoviedb.org/t/p/w440_and_h660_face/eEVauco4LVwu1LixmZGUddAnghy.jpg",
       "Ridley Scott": "https://media.themoviedb.org/t/p/w440_and_h660_face/zABJmN9opmqD4orWl3KSdCaSo7Q.jpg",
       "Damien Chazelle": "https://media.themoviedb.org/t/p/w440_and_h660_face/eTaJchHKDccgEGrbYzVumPzkneZ.jpg",
       "Tim Burton": "https://media.themoviedb.org/t/p/w440_and_h660_face/yHEHAHQpN9PfSEQx1UxZPczhcAi.jpg",
       "Robert Zemeckis": "https://media.themoviedb.org/t/p/w440_and_h660_face/eB64gT0tY3x7veXLjN6Ea7Bw2Y8.jpg",
       "Sam Mendes": "https://media.themoviedb.org/t/p/w440_and_h660_face/5z89X9rB76JDblqMQ52fviwXxAN.jpg",
       "Frank Darabont": "https://media.themoviedb.org/t/p/w440_and_h660_face/7LqmE3p1XTwCdNCOmBxovq210Qk.jpg",
       "Rian Johnson": "https://media.themoviedb.org/t/p/w440_and_h660_face/uPWwvdppeZVKPbYcjXKU8zyuAVh.jpg",
       "Francis Ford Coppola": "https://media.themoviedb.org/t/p/w440_and_h660_face/oBRuGYppfWGkn3xvr9s0aETqIzh.jpg",
       "Ari Aster": "https://media.themoviedb.org/t/p/w440_and_h660_face/vVQai1yKGStv4x7TZdZS4X8MEyP.jpg"
   };

   const referenceSagas = {
       "Star Wars": ["Star Wars, √©pisode I : La Menace fant√¥me", "Star Wars, √©pisode II : L'Attaque des clones", "Star Wars, √©pisode III : La Revanche des Sith", "Star Wars, √©pisode IV : Un nouvel espoir", "Star Wars, √©pisode V : L'Empire contre-attaque", "Star Wars, √©pisode VI : Le Retour du Jedi", "Star Wars, √©pisode VII : Le R√©veil de la Force", "Star Wars, √©pisode VIII : Les Derniers Jedi", "Star Wars, √©pisode IX : L'Ascension de Skywalker", "Rogue One"],
       "Terre du Milieu": ["Le Seigneur des anneaux : La Communaut√© de l'anneau", "Le Seigneur des anneaux : Les Deux Tours", "Le Seigneur des anneaux : Le Retour du roi", "Le Hobbit : Un voyage inattendu", "Le Hobbit : La D√©solation de Smaug", "Le Hobbit : La Bataille des Cinq Arm√©es"],
       "Harry Potter": ["Harry Potter √† l'√©cole des sorciers", "Harry Potter et la Chambre des secrets", "Harry Potter et le Prisonnier d'Azkaban", "Harry Potter et la Coupe de feu", "Harry Potter et l'Ordre du Ph√©nix", "Harry Potter et le Prince de sang-m√™l√©", "Harry Potter et les Reliques de la Mort - 1√®re partie", "Harry Potter et les Reliques de la Mort - 2√®me partie"],
       "Dark Knight": ["Batman Begins", "The Dark Knight", "The Dark Knight Rises"],
       "Dune": ["Dune : Premi√®re Partie", "Dune : Deuxi√®me Partie"],
       "Jurassic Park": ["Jurassic Park", "Le Monde perdu : Jurassic Park", "Jurassic Park III", "Jurassic World", "Jurassic World: Fallen Kingdom", "Jurassic World : Le Monde d'apr√®s", "Jurassic World: Renaissance"],
       "Mission: Impossible": ["Mission: Impossible", "Mission: Impossible 2", "Mission: Impossible 3", "Mission: Impossible - Protocole Fant√¥me", "Mission: Impossible - Rogue Nation", "Mission: Impossible - Fallout", "Mission: Impossible - Dead Reckoning", "Mission: Impossible - The Final Reckoning"],
       "Retour vers le futur": ["Retour vers le futur", "Retour vers le futur II", "Retour vers le futur III"],
       "28 jours plus tard": ["28 jours plus tard", "28 semaines plus tard", "28 ans plus tard", "28 ans plus tard: Le temple des morts"],
       "DCEU": ["Man of Steel", "Batman v Superman: L'aube de la justice", "Suicide Squad", "Wonder Woman", "Aquaman", "Shazam!", "Birds of Prey", "Wonder Woman 1984", "Zack Snyder's Justice League", "The Suicide Squad", "Black Adam", "Shazam! La Rage des Dieux", "The Flash", "Blue Beetle", "Aquaman et le Royaume perdu"],
       "DCU": ["Superman", "Supergirl"],
       "Alien": ["Alien", "Aliens : Le Retour", "Alien 3", "Alien : La R√©surrection", "Prometheus", "Alien : Covenant", "Alien : Romulus"],
       "Spider-Man": ["Spider-Man", "Spider-Man 2", "Spider-Man 3", "The Amazing Spider-Man", "The Amazing Spider-Man : Le Destin d'un h√©ros", "Spider-Man: Homecoming", "Spider-Man: New Generation", "Spider-Man: Far From Home", "Spider-Man: No Way Home", "Spider-Man: Across the Spider-Verse"],
       "MCU": ["Iron Man", "L'Incroyable Hulk", "Iron Man 2", "Thor", "Captain America : First Avenger", "Avengers", "Iron Man 3", "Thor : Le Monde des t√©n√®bres", "Captain America : Le Soldat de l'hiver", "Les Gardiens de la Galaxie", "Avengers : L'√àre d'Ultron", "Ant-Man", "Captain America : Civil War", "Doctor Strange", "Les Gardiens de la Galaxie Vol.2", "Spider-Man : Homecoming", "Thor : Ragnarok", "Black Panther", "Avengers : Infinity War", "Ant-Man et la Gu√™pe", "Captain Marvel", "Avengers : Endgame", "Spider-Man : Far From Home", "Black Widow", "Shang-Chi et la L√©gende des Dix Anneaux", "Les √âternels", "Spider-Man : No Way Home", "Doctor Strange in the Multiverse of Madness", "Thor : Love and Thunder", "Black Panther : Wakanda Forever", "Ant-Man et la Gu√™pe : Quantumania", "Les Gardiens de la Galaxie Vol.3", "The Marvels", "Deadpool et Wolverine", "Captain America : Brave New World", "Thunderbolts*", "Les Quatre Fantastiques : Premiers pas"],
       "Dragons": ["Dragons", "Dragons 2", "Dragons 3 : Le Monde cach√©", "Dragons (2025)"]
   };

   const sagaPhotos = {
       "Star Wars": "https://www.webstickersmuraux.com/fr/img/as555-jpg/folder/products-listado-merchanthover/stickers-muraux-star-wars-logo.jpg",
       "Harry Potter": "https://i.pinimg.com/1200x/04/de/6c/04de6c54756002cfc7ada5dbd6722629.jpg",
       "Terre du Milieu": "https://sw6.elbenwald.de/media/ee/74/75/1701733729/E1059099_6.jpg",
       "Dark Knight": "https://i.ebayimg.com/images/g/f0YAAOSwCU1Y1IgY/s-l1200.jpg",
       "Dune": "https://images.seeklogo.com/logo-png/41/1/dune-2021-logo-png_seeklogo-411365.png",
       "Jurassic Park": "https://sw6.elbenwald.de/media/8c/68/07/1629826122/E1052717_6.jpg",
       "Mission: Impossible": "https://images.seeklogo.com/logo-png/9/1/mission-impossible-logo-png_seeklogo-93407.png",
       "Retour vers le futur": "https://passion-stickers.com/2573-home_default/stickers-retour-vers-le-futur.jpg",
       "28 jours plus tard": "https://i.redd.it/do-you-prefer-the-squared-or-rounded-28-logo-v0-tij8fo8zvx5f1.png?width=740&format=png&auto=webp&s=22e999d5745b2d02b6637a0e3e16540d8945a785",
       "DCEU": "https://upload.wikimedia.org/wikipedia/commons/3/3d/DC_Comics_logo.svg",
       "DCU": "https://cdn.worldvectorlogo.com/logos/dc.svg",
       "Alien": "https://i.ebayimg.com/images/g/0NkAAOSwLyJdniLX/s-l1200.jpg",
       "Spider-Man": "https://i.ebayimg.com/images/g/ypIAAOSw8gpdioNl/s-l400.png",
       "MCU": "https://thumbs.dreamstime.com/b/logo-merisier-conception-de-mervel-marvel-est-une-compagnie-am%C3%A9ricaine-divertissement-179548774.jpg",
       "Dragons": "https://comptoirdugeek.com/cdn/shop/files/Dragons_Dreamworks.png?v=1683806082&width=1500"
   };

   function getSagaAvatar(name, ownedMovies) {
       if (sagaPhotos[name] && sagaPhotos[name].length > 0) {
           return sagaPhotos[name];
       }
       
       if (ownedMovies && ownedMovies.length > 0) {
           const first = ownedMovies[0];
           if (first.poster || first.netflixPoster) {
               return first.poster || first.netflixPoster;
           }
       }

       return "https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=random&size=128";
   }

   function getDirectorAvatar(name) {
       if (directorPhotos[name]) {
           return directorPhotos[name];
       }
       
       return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=256&font-size=0.4`;
   }

   tabBingoBtn.addEventListener('click', () => {
       currentView = 'bingo';
       setActiveTab('bingo');
       hideAllViews();
       bingoView.classList.remove('hidden');
       renderBingoHub(); // On affiche d'abord le menu de choix
   });

   function renderBingoHub() {
       bingoView.innerHTML = `
        <div class="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in">
            <div class="mb-10 text-center">
                <h2 class="text-5xl font-black text-white mb-4 drop-shadow-lg">üéØ Espace Bingo</h2>
                <p class="text-slate-400 text-lg">Choisissez votre d√©fi de collectionneur</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl px-4">
                <div id="btnBingoDirectors" class="group relative h-64 bg-gradient-to-br from-purple-900/40 to-blue-900/40 border border-white/10 rounded-3xl overflow-hidden cursor-pointer hover:border-white/30 transition-all hover:scale-[1.02] shadow-2xl">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center opacity-40 group-hover:opacity-60 transition duration-500 group-hover:scale-110"></div>
                    <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center z-10 p-6 text-center">
                        <div class="text-6xl mb-4 group-hover:-translate-y-2 transition duration-300">üé¨</div>
                        <h3 class="text-3xl font-black text-white uppercase tracking-wider">R√©alisateurs</h3>
                        <p class="text-slate-300 mt-2 text-sm font-medium">Compl√©tez les filmographies des ma√Ætres du cin√©ma.</p>
                    </div>
                </div>

                <div id="btnBingoSagas" class="group relative h-64 bg-gradient-to-br from-red-900/40 to-orange-900/40 border border-white/10 rounded-3xl overflow-hidden cursor-pointer hover:border-white/30 transition-all hover:scale-[1.02] shadow-2xl">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1626814026160-2237a95fc5a0?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center opacity-40 group-hover:opacity-60 transition duration-500 group-hover:scale-110"></div>
                    <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center z-10 p-6 text-center">
                        <div class="text-6xl mb-4 group-hover:-translate-y-2 transition duration-300">üçø</div>
                        <h3 class="text-3xl font-black text-white uppercase tracking-wider">Sagas</h3>
                        <p class="text-slate-300 mt-2 text-sm font-medium">Rassemblez les franchises l√©gendaires.</p>
                    </div>
                </div>
            </div>
        </div>
       `;

       document.getElementById('btnBingoDirectors').onclick = () => renderBingoList('directors');
       document.getElementById('btnBingoSagas').onclick = () => renderBingoList('sagas');
   }

   function renderBingoList(type) {
       const isSaga = type === 'sagas';
       const title = isSaga ? "üçø Bingo Sagas" : "üé¨ Bingo R√©alisateurs";
       const subTitle = isSaga ? "Compl√©tez les grandes franchises" : "Compl√©tez les filmographies cultes";
       const dataObj = isSaga ? referenceSagas : referenceFilmographies;
       
       bingoView.innerHTML = `
        <div class="animate-fade-in">
            <div class="flex items-center gap-4 mb-8">
                <button id="backToBingoHub" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition border border-white/10">
                    ‚¨Ö
                </button>
                <div>
                    <h2 class="text-3xl font-black text-white">${title}</h2>
                    <p class="text-slate-400 text-sm">${subTitle}</p>
                </div>
            </div>
            <div id="bingoGridContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
       `;

       document.getElementById('backToBingoHub').onclick = renderBingoHub;
       
       const grid = document.getElementById('bingoGridContainer');
       const today = new Date();
       const targetKeys = Object.keys(dataObj);

       targetKeys.forEach(keyName => {
           const refList = dataObj[keyName];
           
           const ownedMovies = state.all.filter(m => {
               const matchContext = isSaga ? true : (m.directors && m.directors.includes(keyName));
               
               const matchTitle = refList.some(refTitle => refTitle.toLowerCase() === m.title.toLowerCase());
               
               const isWishlist = (m.tags && m.tags.includes('wishlist')) || 
                                  (m.categories && m.categories.includes('wishlist'));
               const isUpcoming = (m.added && new Date(m.added) > today);

               return matchContext && matchTitle && !isWishlist && !isUpcoming;
           });
           
           const totalMovies = refList.length;
           const ownedCount = ownedMovies.length;
           const progress = Math.round((ownedCount / totalMovies) * 100);
           
           let barColor = "bg-slate-600";
           if(progress === 100) barColor = "bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)]";
           else if(progress >= 75) barColor = "bg-green-500";
           else if(progress >= 50) barColor = "bg-blue-500";
           else if(progress >= 25) barColor = "bg-orange-500";

           let avatarHtml = '';
           if (!isSaga) {
                avatarHtml = `<img src="${getDirectorAvatar(keyName)}" class="w-16 h-16 rounded-full object-cover object-top border-2 border-white/10 shadow-lg group-hover:scale-110 transition-transform" />`;
           } else {
                const sagaIconSrc = getSagaAvatar(keyName, ownedMovies);
                avatarHtml = `<img src="${sagaIconSrc}" class="w-16 h-16 rounded-lg object-cover border-2 border-white/10 shadow-lg group-hover:scale-110 transition-transform" />`;
           }

           const card = document.createElement('div');
           card.className = "bg-white/5 border border-white/10 rounded-2xl p-4 hover:bg-white/10 transition cursor-pointer group relative overflow-hidden flex flex-col justify-between h-full";
           
           card.innerHTML = `
                <div class="flex items-start gap-4 mb-4 relative z-10">
                    ${avatarHtml}
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-white leading-tight group-hover:text-red-400 transition-colors line-clamp-2">${keyName}</h3>
                        <div class="text-xs text-slate-400 mt-1">${ownedCount} / ${totalMovies} films</div>
                    </div>
                </div>
                
                <div class="mt-auto relative w-full h-3 bg-black/50 rounded-full overflow-hidden z-10">
                    <div class="absolute top-0 left-0 h-full ${barColor} transition-all duration-1000" style="width: ${progress}%"></div>
                </div>
                <div class="text-right text-xs font-bold mt-1 ${progress === 100 ? 'text-yellow-500' : 'text-slate-500'}">${progress}%</div>

                <div class="absolute -bottom-6 -right-6 text-[120px] opacity-[0.03] rotate-12 pointer-events-none select-none grayscale">
                    ${isSaga ? 'üçø' : 'üé¨'}
                </div>
           `;

           card.addEventListener('click', () => openBingoCard(keyName, refList, isSaga));
           grid.appendChild(card);
       });
   }

   function openBingoCard(name, refList, isSaga = false) {
        const modal = document.getElementById('bingoModal');
        const content = document.getElementById('bingoContent');
        const grid = document.getElementById('bingoGrid');
        
        document.getElementById('bingoDirectorName').textContent = name;
        
        const headerAvatar = document.getElementById('bingoAvatar');
        if(!isSaga) {
             headerAvatar.className = "w-full h-full object-cover";
             headerAvatar.parentElement.className = "w-24 h-24 rounded-full border-4 border-[#1a1a1a] overflow-hidden shadow-xl shrink-0 bg-slate-700";
             headerAvatar.src = getDirectorAvatar(name);
        } else {
             headerAvatar.className = "w-full h-full object-cover";
             headerAvatar.parentElement.className = "w-24 h-24 rounded-xl border-4 border-[#1a1a1a] overflow-hidden shadow-xl shrink-0 bg-slate-700";
             headerAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=333&color=fff`; 
        }
        
        const ownedMap = new Map();
        const today = new Date(); 

        state.all.forEach(m => {
            const isWishlist = (m.tags && m.tags.includes('wishlist')) || 
                               (m.categories && m.categories.includes('wishlist'));
            const isUpcoming = (m.added && new Date(m.added) > today);

            const matchContext = isSaga ? true : (m.directors && m.directors.includes(name));

            if (matchContext && !isWishlist && !isUpcoming) {
                ownedMap.set(m.title.toLowerCase(), m);
            }
        });

        let ownedCount = 0;
        refList.forEach(refTitle => {
            if (ownedMap.has(refTitle.toLowerCase())) ownedCount++;
        });
        const pct = Math.round((ownedCount / refList.length) * 100);
        document.getElementById('bingoScore').textContent = `${pct}%`;

        const firstOwnedKey = Array.from(ownedMap.keys())[0]; 
        const firstOwned = firstOwnedKey ? ownedMap.get(firstOwnedKey) : null;
        const bgImg = firstOwned ? (firstOwned.poster || firstOwned.netflixPoster) : '';
        document.getElementById('bingoHeaderImg').src = bgImg;

        if(isSaga) {
            const sagaMovies = Array.from(ownedMap.values());
            headerAvatar.src = getSagaAvatar(name, sagaMovies);
        } else if (bgImg && !isSaga) {
        }

        grid.innerHTML = '';

        refList.forEach(refTitle => {
            const lowerTitle = refTitle.toLowerCase();
            const isOwned = ownedMap.has(lowerTitle);

            const card = document.createElement('div');
            
            if (isOwned) {
                 const m = ownedMap.get(lowerTitle);
                 const poster = m.poster || m.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
                
                card.className = "relative group aspect-[2/3] rounded-xl overflow-hidden border-2 border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.2)] transition transform hover:scale-105 cursor-pointer";
                card.innerHTML = `
                    <img src="${poster}" class="w-full h-full object-cover" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
                        <span class="text-green-400 font-bold text-xs uppercase tracking-wider">Acquis</span>
                        <span class="text-white font-semibold leading-tight text-sm">${m.title}</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg">‚úì</div>
                `;
                card.onclick = () => {
                    closeBingoModal();
                    openModal(m); 
                };
            } else {
                const foundInOtherLists = state.all.find(m => m.title.toLowerCase() === lowerTitle);

                if (foundInOtherLists) {
                    let label = "En attente";
                    let colorClass = "text-blue-400";
                    let borderClass = "border-blue-500/50";
                    let icon = "üìÖ";

                    const isWishlist = (foundInOtherLists.tags && foundInOtherLists.tags.includes('wishlist')) || 
                                       (foundInOtherLists.categories && foundInOtherLists.categories.includes('wishlist'));
                    
                    if (isWishlist) {
                        label = "Wishlist";
                        colorClass = "text-purple-400";
                        borderClass = "border-purple-500/50";
                        icon = "üéÅ";
                    } else {
                        label = "Prochainement";
                    }

                    card.className = `relative aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-dashed ${borderClass} flex flex-col items-center justify-center p-4 text-center hover:bg-white/10 transition cursor-pointer`;
                    card.innerHTML = `
                        <div class="text-4xl mb-2">${icon}</div>
                        <div class="text-sm font-semibold text-slate-300 leading-tight line-clamp-3">${refTitle}</div>
                        <div class="mt-2 text-[10px] uppercase tracking-widest ${colorClass} font-bold">${label}</div>
                    `;
                    card.onclick = () => {
                        closeBingoModal();
                        openModal(foundInOtherLists);
                    };

                } else {
                    card.className = "relative aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-dashed border-white/20 flex flex-col items-center justify-center p-4 text-center grayscale opacity-60 hover:opacity-100 transition hover:bg-white/10 cursor-pointer";
                    card.innerHTML = `
                        <div class="text-4xl mb-2 opacity-20">üìº</div>
                        <div class="text-sm font-semibold text-slate-400 leading-tight line-clamp-3">${refTitle}</div>
                        <div class="mt-2 text-[10px] uppercase tracking-widest text-red-400 font-bold">Manquant</div>
                    `;
                    card.onclick = () => {
                        const query = encodeURIComponent(refTitle);
                        window.open(`https://www.imdb.com/find/?q=${query}`, '_blank');
                    };
                }
            }
            grid.appendChild(card);
        });

        modal.classList.remove('hidden');
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
   }

   function closeBingoModal() {
        const modal = document.getElementById('bingoModal');
        const content = document.getElementById('bingoContent');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
   }

   document.getElementById('closeBingo').onclick = closeBingoModal;
   document.getElementById('bingoBackdrop').onclick = closeBingoModal;

   

   loadInitial();
  </script>

  <script>
    const GITHUB_USERNAME = "Mathis1371"; // Ex: jean-dupont
    const GITHUB_REPO = "Collection-blu-ray";         // Ex: ma-collection-bluray

    const btn = document.getElementById('bugReportBtn');
    
    const userAgent = navigator.userAgent;
    const screenRes = `${window.screen.width}x${window.screen.height}`;
    
    const title = encodeURIComponent("Rapport de bug");
    const body = encodeURIComponent(
  `**Description du probl√®me :**
  (D√©crivez ce qu'il se passe ici...)

  **Comment reproduire le bug :**
  1. 
  2. 
  3. 

  ---
  *Infos techniques (automatique) :*
  *Navigateur : ${userAgent}*
  *R√©solution : ${screenRes}*`
    );

    btn.href = `https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/issues/new?title=${title}&body=${body}`;
  </script>

</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="theme-color" content="#2a181c">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ma collection de blu-ray ‚Äî Local</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Interface locale type Netflix pour cataloguer vos films sans lecture vid√©o.">
  <style>
    /* D√©grad√© d'arri√®re-plan discret */
   html, body {
      margin: 0;
      padding: 0;
      background-color: rgb(42, 24, 28); 
      background-image: linear-gradient(to right, rgb(42, 24, 28), rgb(42, 24, 28));
      min-height: 100%;
    }
    .poster { object-fit: cover; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); }

   /* --- Navigation Carrousel style Netflix --- */
   .carousel-wrapper {
     position: relative;
   }

   /* Les boutons (masqu√©s par d√©faut, visibles au survol du wrapper) */
   .nav-btn {
     position: absolute;
     top: 0;
     bottom: 1rem;
     z-index: 40;
     width: 3rem; /* Largeur de la zone cliquable */
     background: rgba(0,0,0,0.5);
     color: white;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     border: none;
     opacity: 0; /* Invisible par d√©faut */
     transition: opacity 0.3s ease, background 0.3s ease;
     font-size: 2rem;
     user-select: none;
   }

   /* Afficher les fl√®ches quand on passe la souris sur la ligne */
   .carousel-wrapper:hover .nav-btn {
     opacity: 1;
   }

   .nav-btn:hover {
     background: rgba(0,0,0,0.8);
     transform: scale(1.1); /* Petit zoom effet pop */
   }

   .nav-left { left: 0; border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
   .nav-right { right: 0; border-top-left-radius: 4px; border-bottom-left-radius: 4px; }

   /* Ajustement du carrousel pour cacher la scrollbar proprement */
   .carousel {
     scroll-behavior: smooth; /* Animation fluide native */
   }

   #netflixBanner {
     width: 100%;
     overflow: hidden;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     position: relative;
     /* On passe le dernier chiffre √† 10px (au lieu de 60px) */
     padding: 20px 0 10px 0; 
   }

   #bannerSection {
     width: 100%;
     height: 420px;
     display: flex;
     align-items: center;
     justify-content: center;
     overflow: hidden;
     position: relative;
   }

   #bannerCarousel {
     display: flex;
     align-items: center;
     gap: 1.5rem;
     transition: transform 0.8s ease; /* animation du translateX */
     will-change: transform;
     width: max-content;         /* s'adapte au contenu */
   }

   .banner-card {
     position: relative;
     width: 900px;
     height: 520px;
     border-radius: 24px;
     overflow: hidden; /* Coupe tout ce qui d√©passe */
     flex-shrink: 0;
     opacity: 0.6;
     transform: scale(0.95);
     transition: transform 0.6s ease, opacity 0.6s ease;
     cursor: pointer;
     background-color: #000; /* Fond noir de s√©curit√© */
     
     /* On enl√®ve tout le reste */
     border: none;
     outline: none;
     box-shadow: none;
   }

   .banner-card::after {
     content: '';
     position: absolute;
     inset: 0; /* Prend toute la taille de la carte */
     border-radius: 24px; /* Suit parfaitement l'arrondi */
     
     /* Une ombre interne de 1px qui mange les pixels blancs sur les bords */
     box-shadow: inset 0 0 0 1px #000; 
     
     z-index: 20; /* Se place PAR-DESSUS l'image */
     pointer-events: none; /* Permet de cliquer au travers */
   }

   .banner-card.active {
     transform: scale(1.03);
     opacity: 1;
     z-index: 2;
   }

   .banner-card img {
     width: 100%;
     height: 100%;
     object-fit: cover;
     display: block;
     border-radius: 24px;
     transform: scale(1.01); 
   }

   .banner-gradient {
     position: absolute;
     bottom: 0; 
     left: 0;
     right: 0;
     height: 40%; 
     
     /* RETOUR AU D√âGRAD√â FLUIDE (sans bordure solide) */
     /* On force le noir pur (#000) sur les 2 premiers % pour la fusion */
     background: linear-gradient(to top, #000 0%, #000 2%, rgba(0,0,0,0.8) 25%, transparent 100%);
     
     pointer-events: none;
     z-index: 5;
     border: none; /* On supprime la bordure moche */
   }

   .banner-info {
     position: absolute;
     bottom: 0;
     left: 0;
     padding: 2rem 2.5rem; 
     width: 100%;
     z-index: 10;
     display: flex;
     flex-direction: column; /* <--- C'est ici qu'√©tait l'erreur (au lieu de flex-col: column) */
     align-items: flex-start;
   }

   .actor-link {
     color: #f87171; /* rouge clair */
     cursor: pointer;
   }
   .actor-link:hover {
   text-decoration: underline;
   }

   .stats-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
     gap: 1rem;
     margin-top: 1rem;
   }

   .stat-card {
     background: rgba(255,255,255,0.03);
     border: 1px solid rgba(255,255,255,0.05);
     padding: 1rem;
     border-radius: 12px;
     min-height: 110px;
   }

   .stat-title { font-size: 0.9rem; color: #cbd5e1; margin-bottom: .5rem; }
   .stat-value { font-size: 1.4rem; font-weight: 700; color: #fff; }

   /* Bar chart simple */
   .genre-bar {
     display: flex;
     gap: .75rem;
     align-items: center;
     margin-bottom: .5rem;
   }
   .genre-label { width: 120px; font-size: .85rem; color: #e6eef8; }
   .bar {
     height: 14px;
     width: 100%;
     background: rgba(255,255,255,0.06);
     border-radius: 999px;
     overflow: hidden;
   }
   .bar-fill {
     height: 100%;
     width: 0%;
     border-radius: 999px;
     background: linear-gradient(90deg,#f97316,#ef4444); /* orange‚Üíred */
     transition: width 600ms ease;
   }

   /* Donut simple (conic-gradient) */
   .donut {
     width: 120px;
     height: 120px;
     border-radius: 50%;
     display:flex;
     align-items:center;
     justify-content:center;
     position: relative;
     margin: 0 auto;
     box-shadow: inset 0 0 0 12px rgba(0,0,0,0.35);
   }
   .donut-center {
     width: 68px;
     height: 68px;
     border-radius: 50%;
     background: rgba(0,0,0,0.6);
     display:flex;
     align-items:center;
     justify-content:center;
     color: #fff;
     font-weight:700;
     font-size: .9rem;
   }

   /* Animation de tremblement pour le gagnant */
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-effect {
      animation: shake 0.5s;
      animation-iteration-count: 1;
    }
   
   .no-scrollbar::-webkit-scrollbar {
     display: none;
   }
   
   .no-scrollbar {
     -ms-overflow-style: none;  /* IE and Edge */
     scrollbar-width: none;  /* Firefox */
   }

   .stats-legend { display:flex; gap: .75rem; align-items:center; justify-content:center; margin-top:.75rem; color:#cbd5e1; font-size: .85rem; }
   .legend-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:.35rem; }

   #bannerCarousel {
     cursor: grab;
   }
   #bannerCarousel:active {
     cursor: grabbing;
   }
   .banner-card img {
     pointer-events: none; /* Emp√™che le navigateur de vouloir glisser l'image elle-m√™me */
     user-select: none;
   }

   /* --- Indicateurs (Points) du Carrousel --- */
   .banner-indicators {
     position: relative;
     margin-top: 30px;        /* <--- Ajoutez 30px d'√©cart ici */
     display: flex;
     justify-content: center;
     gap: 10px;
     z-index: 30;
     padding: 10px;
     border-radius: 20px;
   }
   
   .indicator-dot {
     width: 10px;
     height: 10px;
     border-radius: 50%;
     background-color: rgba(255, 255, 255, 0.3);
     cursor: pointer;
     transition: all 0.3s ease;
     box-shadow: 0 2px 4px rgba(0,0,0,0.5);
   }
   
   .indicator-dot:hover {
     background-color: rgba(255, 255, 255, 0.6);
     transform: scale(1.1);
   }
   
   .indicator-dot.active {
     background-color: #fff;
     transform: scale(1.3);
     box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
   }
</style>
</head>
<body class="min-h-screen text-slate-100">
  <header class="sticky top-0 z-30 border-b border-white/10 bg-black/80 backdrop-blur-md">
    <div class="mx-auto max-w-7xl px-4 py-3 flex flex-col lg:flex-row items-center justify-between gap-4 lg:gap-8">
    
       <h1 class="text-2xl sm:text-3xl font-extrabold tracking-wide bg-gradient-to-r from-red-600 via-red-500 to-red-600 bg-clip-text text-transparent drop-shadow-lg shrink-0">
         üé¨ Ma collection
       </h1>

       <nav class="overflow-x-auto no-scrollbar w-full lg:w-auto lg:flex-1 lg:ml-4">
           <ul class="flex items-center justify-center lg:justify-start gap-6 min-w-max">
             <li><button id="tabMain" class="nav-item text-base transition-all duration-300">Accueil</button></li>
             <li><button id="tabGrid" class="nav-item text-base transition-all duration-300">Catalogue</button></li>
             <li><button id="tabUpcoming" class="nav-item text-base transition-all duration-300">Prochainement</button></li>
             <li><button id="tabWishlist" class="nav-item text-base transition-all duration-300">Wishlist</button></li>
             <li><button id="tabStats" class="nav-item text-base transition-all duration-300">Stats</button></li>
           </ul>
       </nav>

       <div class="flex items-center gap-3 shrink-0">
           <a id="bugReportBtn" 
              target="_blank" 
              class="cursor-pointer group flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 hover:border-white/40 transition-all duration-300 text-decoration-none">
             <span class="text-lg group-hover:rotate-12 transition-transform">üêõ</span>
             <span class="hidden sm:inline text-sm font-medium text-slate-300 group-hover:text-white">Signaler un bug</span>
           </a>

           <input id="jsonFile" type="file" accept="application/json" class="hidden" />
           <label for="jsonFile" class="cursor-pointer group flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 hover:border-white/40 transition-all duration-300">
             <span class="text-lg group-hover:scale-110 transition-transform">üìÇ</span>
             <span class="text-sm font-medium text-slate-300 group-hover:text-white">Importer JSON</span>
           </label>
       </div>

     </div>
</header>

  <div id="globalFade" 
       class="pointer-events-none fixed top-[80px] right-0 h-[calc(100%-80px)] w-20 
              bg-gradient-to-r from-transparent to-black/80 z-20 hidden"></div>

  <section id="controlsSection" class="mx-auto max-w-7xl px-4 py-6 hidden">
    
    <div class="sm:hidden mb-4">
        <button id="toggleFiltersBtn" class="w-full py-2 bg-white/10 rounded-xl text-sm font-bold uppercase tracking-wide hover:bg-white/20 transition">
            Afficher les filtres & tri
        </button>
    </div>

    <div id="filterInputsContainer" class="hidden sm:grid gap-3 md:grid-cols-12 items-end">
      <div class="md:col-span-5">
        <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Recherche</label>
        <input id="searchInput" type="search" placeholder="Titre, acteur, r√©alisateur, mot-cl√©‚Ä¶" class="w-full px-4 py-3 rounded-2xl bg-white/10 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-red-500" />
      </div>
      <div class="md:col-span-3">
        <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Genre</label>
        <select id="genreSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="">Tous</option>
        </select>
      </div>
      <div class="md:col-span-3">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">P√©riode</label>
       <select id="periodSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Toutes</option>
         <option value="1960-1969">ann√©es 60</option>
         <option value="1970-1979">ann√©es 70</option>
         <option value="1980-1989">ann√©es 80</option>
         <option value="1990-1999">ann√©es 90</option>
         <option value="2000-2009">ann√©es 2000</option>
         <option value="2010-2019">ann√©es 2010</option>
         <option value="2020-2029">ann√©es 2020</option>
       </select>
      </div>
      <div class="md:col-span-3">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Pays</label>
       <select id="countrySelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Tous</option>
       </select>
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Dur√©e</label>
       <select id="runtimeSelect" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
         <option value="">Toutes</option>
         <option value="short">Moins de 2h</option>
         <option value="medium">2h √† 2h30</option>
         <option value="long">Plus de 2h30</option>
       </select>
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Ann√©e exacte</label>
       <input id="yearExact" type="number" placeholder="1950" class="w-full px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500" />
      </div>
      <div class="md:col-span-2">
       <label class="block text-xs uppercase tracking-wide text-slate-300 mb-1">Trier</label>
       <div class="flex gap-2">
         <select id="sortSelect" class="flex-1 px-4 py-3 rounded-2xl bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-500">
           <option value="title">Titre (A‚ÜíZ)</option>
           <option value="year">Ann√©e (‚Üì)</option>
           <option value="rating">Note (‚Üì)</option>
           <option value="runtime">Dur√©e (‚Üì)</option>
           <option value="added">Ajout√© r√©cemment</option>
         </select>
         <button id="sortDirBtn" class="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/20">‚¨ÜÔ∏é</button>
       </div>
      </div>
      <div class="md:col-span-12 mt-4 flex gap-3">
        <button id="resetBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">R√©initialiser</button>
        <button id="randomBtn" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700">Film al√©atoire</button>
      </div>
    </div>
  </section>

  <div id="netflixBanner" class="hidden flex flex-col items-center justify-center overflow-hidden relative">
     <div id="bannerCarousel" class="flex transition-transform duration-700 ease-in-out"></div>
   </div>

  <main id="mainView" class="mx-auto max-w-7xl px-4 pb-24 mt-6"></main>

  <main id="gridView" class="mx-auto max-w-7xl px-4 pb-24 hidden mt-6">
   <div id="resultCount" class="mb-4 text-sm opacity-80"></div>
   <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6"></div>
  </main>

  <main id="upcomingView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>
  <main id="wishlistView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>
  <main id="statsView" class="mx-auto max-w-7xl px-4 pb-24 mt-6 hidden"></main>

  <div id="modal" class="hidden fixed inset-0 z-50">
   <div id="modalBackdrop" class="absolute inset-0 bg-black/70"></div>

   <div id="modalContent"
        class="relative mx-auto mt-16 w-[92vw] max-w-4xl rounded-3xl glass p-4 md:p-6 shadow-2xl border border-white/10
              transition-all duration-200 transform scale-95 opacity-0 overflow-y-auto max-h-[85vh]">
     <button id="modalClose" class="absolute top-3 right-3 px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 z-10">Fermer</button>
     <div class="grid md:grid-cols-3 gap-4">
       <div class="relative">
         <img id="modalPoster" class="w-full h-72 md:h-full rounded-2xl object-cover border border-white/10" alt="Poster" />
         </div>
       <div class="md:col-span-2 space-y-3">
         <h3 id="modalTitle" class="text-2xl font-semibold pr-16"></h3>
         <div class="flex flex-wrap gap-2 text-sm opacity-80" id="modalMeta"></div>
         <div id="modalActors" class="text-xs opacity-80 mt-1"></div>
         <div id="modalCountry" class="text-xs opacity-80 mt-1"></div>
         <p id="modalOverview" class="text-slate-200 text-sm leading-relaxed"></p>
         <div id="modalPrice" class="font-bold text-slate-200 text-lg my-2 hidden"></div>
         <div id="modalTags" class="flex flex-wrap gap-2"></div>
       </div>
     </div>
   </div>
  </div>
  
  <div id="randomRoulette" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-500">
   <div class="relative w-64 h-96 rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(220,38,38,0.4)] border border-white/10 ring-4 ring-white/5">
     <img id="roulettePoster" src="" class="w-full h-full object-cover" />
     <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20"></div>
   </div>
   <h2 id="rouletteTitle" class="mt-8 text-3xl font-bold text-center text-white drop-shadow-lg px-4 animate-pulse">
     Recherche...
   </h2>
   <div class="mt-4 text-red-500 font-mono text-sm tracking-[0.2em] uppercase">S√©lection al√©atoire</div>
  </div>

  <script>

    let state = { all: [], filtered: [], query: "", genre: "", yearExact: "", runtime: "", sort: "title", sortDir: "asc", country: "", period: ""};
    const els = {
      grid: document.getElementById('grid'),
      search: document.getElementById('searchInput'),
      genre: document.getElementById('genreSelect'),
      yearExact: document.getElementById('yearExact'),
      runtime: document.getElementById('runtimeSelect'),
      sort: document.getElementById('sortSelect'),
      reset: document.getElementById('resetBtn'),
      count: document.getElementById('resultCount'),
      jsonFile: document.getElementById('jsonFile'),
      period: document.getElementById('periodSelect'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalPoster: document.getElementById('modalPoster'),
      modalTitle: document.getElementById('modalTitle'),
      country: document.getElementById('countrySelect'),
      modalMeta: document.getElementById('modalMeta'),
      modalOverview: document.getElementById('modalOverview'),
      modalTags: document.getElementById('modalTags'),
      modalActors: document.getElementById('modalActors'),
      modalCountry: document.getElementById('modalCountry'),
      modalPrice: document.getElementById('modalPrice'),
      randomBtn: document.getElementById('randomBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      sortDirBtn: document.getElementById('sortDirBtn')
    };

    const filterInputsContainer = document.getElementById('filterInputsContainer');
    const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
    
    // FIX: Le bouton toggle marche maintenant car les ID existent dans le HTML
    if (toggleFiltersBtn && filterInputsContainer) {
        toggleFiltersBtn.addEventListener('click', () => {
            const isHidden = filterInputsContainer.classList.contains('hidden');
            if (isHidden) {
                filterInputsContainer.classList.remove('hidden');
                // filterInputsContainer.classList.add('grid'); // D√©j√† g√©r√© par sm:grid mais on force l'affichage
                toggleFiltersBtn.textContent = "Masquer les filtres & tri";
            } else {
                filterInputsContainer.classList.add('hidden');
                toggleFiltersBtn.textContent = "Afficher les filtres & tri";
            }
        });
    }

    const controlsSection = document.getElementById('controlsSection');
    let currentView = 'netflix';

    const tabMainBtn = document.getElementById("tabMain");
    const tabGridBtn = document.getElementById("tabGrid");
    const tabStatsBtn = document.getElementById("tabStats");
    const statsView = document.getElementById("statsView");

    let currentBannerMovie = null;
    let bannerScrollAnim = null;
    let bannerIndex = 0;
    let bannerMovies = [];
    let bannerInterval = null;

    function setActiveTab(view) {
     const tabs = {
       netflix: tabMainBtn,
       grid: tabGridBtn,
       upcoming: document.getElementById('tabUpcoming'),
       wishlist: document.getElementById('tabWishlist'),
       stats: tabStatsBtn
     };

     // Classes pour l'onglet ACTIF (Blanc, Gras, Curseur par d√©faut)
     const activeClasses = ["text-white", "font-bold", "cursor-default", "scale-105"];
     // Classes pour l'onglet INACTIF (Gris, Normal, Hover effet)
     const inactiveClasses = ["text-slate-400", "font-medium", "hover:text-slate-200", "cursor-pointer"];

     for (const key in tabs) {
         const btn = tabs[key];
         // On retire toutes les classes de style pour √©viter les conflits
         btn.classList.remove(...activeClasses, ...inactiveClasses, "bg-red-600", "bg-white/10", "px-3", "py-1", "rounded"); // Nettoyage des anciennes classes

         if (key === view) {
             btn.classList.add(...activeClasses);
         } else {
             btn.classList.add(...inactiveClasses);
         }
        
         // Si on change de vue Grid vers autre chose, on reset les filtres
         if (currentView === "grid" && view !== "grid") {
             resetFilters();
         }
     }

     const fade = document.getElementById("globalFade");
     if (view === "netflix") {
       fade.classList.remove("hidden");
     } else {
       fade.classList.add("hidden");
     }
     
     // Nettoyage animation
     if (typeof bannerScrollAnim === "number") {
       cancelAnimationFrame(bannerScrollAnim);
       bannerScrollAnim = null;
     }
     if (bannerInterval) {
       clearInterval(bannerInterval);
       bannerInterval = null;
     }
      
     const banner = document.getElementById("netflixBanner");
     if (banner) {
       if (view === "netflix") {
         banner.style.display = "block"; // REVERSION : block comme dans l'original
       } else {
         banner.style.display = "none";
         if (bannerInterval) {
           clearInterval(bannerInterval);
           bannerInterval = null;
         }
         banner.style.transform = "translateX(0)";
       }
     }
     
     if (controlsSection) {
        if (view === 'grid') {
            controlsSection.classList.remove('hidden');
        } else {
            controlsSection.classList.add('hidden');
        }
     }
   }

   setActiveTab(currentView);

    async function loadInitial() {
       try {
         const res = await fetch('data/movies.json', { cache: 'no-store' });
         if (!res.ok) throw new Error('no json');
         const data = await res.json();
         if (!data.movies) throw new Error('bad schema');
         state.all = normalize(data.movies);
       } catch (e) {
         console.log("Aucun fichier automatique trouv√©. En attente d'import manuel.");
         // On initialise avec un tableau vide au lieu des donn√©es d'exemple
         state.all = []; 
       }
      initFilters();
      applyFilters();
    }

    function normalize(arr){
      return arr.map(m=>({
        id: m.id ?? (String(m.title) + String(m.year)).replace(/\s+/g, '_').toLowerCase(),
        title: String(m.title||'Sans titre'),
        year: Number(m.year)||null,
        genres: Array.isArray(m.genres)?m.genres:[],
        categories: Array.isArray(m.categories)?m.categories:[],
        people: Array.isArray(m.people)?m.people:[],
        directors: Array.isArray(m.directors)?m.directors:[],
        runtime: Number(m.runtime)||null,
        rating: Number(m.rating)||null,
        price: Number(m.price)||0,
        marketValue: Number(m.marketValue)||0,
        overview: m.overview||'',
        poster: m.poster||'',
        netflixPoster: m.netflixPoster || '',
        altPoster: m.altPoster || '',
        tags: Array.isArray(m.tags)?m.tags:[],
        country: m.country || '',
        added: m.added||new Date().toISOString().slice(0,10)
      }));
    }

    function initFilters(){
      const genres = [...new Set(state.all.flatMap(m=>m.genres))].sort();
      els.genre.innerHTML = '<option value="">Tous</option>' + genres.map(g=>`<option>${g}</option>`).join('');

      const countries = [...new Set(state.all.map(m => m.country).filter(Boolean))].sort();
      els.country.innerHTML = '<option value="">Tous</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function resetFilters() {
     bannerMovies = [];
     bannerIndex = 0;
     state.query = "";
     state.genre = "";
     state.yearExact = "";
     state.runtime = "";
     state.sort = "title";
     state.sortDir = "asc";
     state.country = "";
     state.period = "";

     els.search.value = "";
     els.genre.value = "";
     els.yearExact.value = "";
     els.runtime.value = "";
     els.sort.value = "title";
     els.country.value = "";
     els.period.value = "";

     applyFilters();
    }

    function applyFilters(){
     const q = state.query.trim().toLowerCase();
     let today = new Date();

     let list = state.all.filter(m => {
       const matchesQ = !q || [
           m.title, 
           ...(m.people||[]), 
           ...(m.directors || []), 
           ...(m.genres||[]), 
           ...(m.tags||[]), // <--- C'est ici que √ßa manquait
           (m.overview||'')
       ].join(' ').toLowerCase().includes(q);
       const matchesG = !state.genre || (m.genres||[]).includes(state.genre);
       const matchesY = !state.yearExact || (m.year||0) === Number(state.yearExact);
       const matchesR = !state.runtime || 
         (state.runtime === "short" && m.runtime && m.runtime < 120) ||
         (state.runtime === "medium" && m.runtime && m.runtime >= 120 && m.runtime <= 150) ||
         (state.runtime === "long" && m.runtime && m.runtime > 150);
       const matchesC = !state.country || (m.country && m.country.toLowerCase().trim() === state.country.toLowerCase().trim());
       const matchesP = !state.period || (() => {const [start, end] = state.period.split('-').map(Number);return m.year && m.year >= start && m.year <= end; })();

       const notUpcoming = currentView === 'grid' || currentView === 'netflix' ? (!m.added || new Date(m.added) <= today) : true;

       const notWishlist = currentView === 'wishlist' ? true : !(
         (m.tags && m.tags.includes('wishlist')) ||
         (m.categories && m.categories.includes('wishlist'))
       );

       return matchesQ && matchesG && matchesY && matchesR && matchesC && matchesP && notUpcoming && notWishlist;
     });

     list.sort((a,b)=>{
         let result = 0;
         switch(state.sort){
           case 'year': result = (a.year||0) - (b.year||0); break;
           case 'rating': result = (a.rating||0) - (b.rating||0); break;
           case 'runtime': result = (a.runtime||0) - (b.runtime||0); break;
           case 'added': result = String(a.added||'').localeCompare(String(b.added||'')); break;
           default: result = String(a.title||'').localeCompare(String(b.title||'')); break;
         }
         return state.sortDir === "asc" ? result : -result;
      });

     state.filtered = list;

     if (currentView === 'netflix') {
       renderNetflixView();
     } else if (currentView === 'stats') {
       renderStats();
     } else if (currentView === 'wishlist') {
       renderWishlistView();
     } else if (currentView === 'upcoming') {
       renderUpcomingView();
     } else {
       renderGrid();
     }
    }
    
    // REVERSION : Code exact de la banni√®re d'origine
    function renderNetflixView() {
        const container = document.getElementById('mainView');
        container.innerHTML = '';
        container.className = "w-full px-4 py-6 relative";

        // Cas vide
        if (state.filtered.length === 0) {
            container.innerHTML = `
              <div class="flex flex-col items-center justify-center h-[60vh] text-center text-slate-400">
                  <div class="text-6xl mb-4 opacity-20">üìÇ</div>
                  <h2 class="text-2xl font-bold text-slate-200 mb-2">Votre collection est vide</h2>
                  <p class="max-w-md mx-auto">
                      Aucun film charg√©. Cliquez sur "Importer JSON".
                  </p>
              </div>
          `;
            document.getElementById('netflixBanner').classList.add('hidden');
            return;
        }

        // Gestion de la Banni√®re
        const banner = document.getElementById('netflixBanner');
        if (currentView === 'netflix' && state.filtered.length > 0) {
            banner.classList.remove('hidden');
        } else {
            banner.classList.add('hidden');
        }

        // 1. Regrouper les films par cat√©gorie
        const categoriesMap = {};
        state.filtered.forEach(movie => {
            (movie.categories || []).forEach(cat => {
                if (!categoriesMap[cat]) categoriesMap[cat] = [];
                categoriesMap[cat].push(movie);
            });
        });

        // 2. Cr√©er les sections avec fl√®ches
        for (const cat in categoriesMap) {
            const section = document.createElement('section');
            section.className = "mb-7 group"; // Marge ajust√©e

            // Titre de la cat√©gorie
            const title = document.createElement('h2');
            title.textContent = cat;
            title.className = "text-xl font-bold mb-3 px-1 flex items-baseline"; 
            section.appendChild(title);

            // Wrapper relatif pour positionner les fl√®ches
            const wrapper = document.createElement('div');
            wrapper.className = "carousel-wrapper relative";

            // --- Bouton Gauche ---
            const btnLeft = document.createElement('button');
            btnLeft.className = "nav-btn nav-left hidden";
            btnLeft.innerHTML = "&#10094;";
            btnLeft.ariaLabel = "Pr√©c√©dent";
            
            // --- Bouton Droite ---
            const btnRight = document.createElement('button');
            btnRight.className = "nav-btn nav-right";
            btnRight.innerHTML = "&#10095;";
            btnRight.ariaLabel = "Suivant";

            // Le Carrousel
            const carousel = document.createElement('div');
            carousel.className = "carousel flex gap-4 overflow-x-auto scroll-smooth no-scrollbar pb-4 px-1";

            // Remplissage des films
            const shuffled = [...categoriesMap[cat]].sort(() => 0.5 - Math.random());
            shuffled.forEach(m => {
                const posterSrc = m.netflixPoster || m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
                
                const card = document.createElement('div');
              
                card.className = 'carousel-item flex-none w-[160px] md:w-[195px] lg:w-[230px] group/card relative cursor-pointer transition-transform duration-300 hover:scale-105 z-10 hover:z-20';
                
                card.innerHTML = `
                    <img src="${posterSrc}" loading="lazy" alt="${m.title}" 
                      class="w-full h-auto aspect-video object-cover rounded-md shadow-lg" />
                `;
                card.addEventListener('click', () => openModal(m));
                carousel.appendChild(card);
            });

            btnLeft.onclick = (e) => {
                e.stopPropagation();
                const scrollAmount = carousel.clientWidth * 0.90;
                carousel.scrollLeft -= scrollAmount;
            };

            btnRight.onclick = (e) => {
                e.stopPropagation();
                const scrollAmount = carousel.clientWidth * 0.90;
                carousel.scrollLeft += scrollAmount;
            };

            const updateArrows = () => {
                if (carousel.scrollLeft > 20) {
                    btnLeft.classList.remove('hidden');
                    btnLeft.style.display = 'flex';
                } else {
                    btnLeft.style.display = 'none';
                }

                const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                if (carousel.scrollLeft >= maxScroll - 20) {
                    btnRight.style.display = 'none';
                } else {
                    btnRight.style.display = 'flex';
                }
            };

            carousel.addEventListener('scroll', updateArrows);
            setTimeout(updateArrows, 100); 

            wrapper.appendChild(btnLeft);
            wrapper.appendChild(carousel);
            wrapper.appendChild(btnRight);
            section.appendChild(wrapper);
            container.appendChild(section);
        }

        if (bannerMovies.length === 0) {
            let candidates = state.filtered.filter(m => m.netflixPoster || m.poster);
            candidates.sort(() => 0.5 - Math.random());
            bannerMovies = candidates.slice(0, 10);
        }
        
        startBannerAutoScroll(); 

        function startBannerAutoScroll() {
          if (bannerInterval) clearInterval(bannerInterval);
          const viewport = document.getElementById('netflixBanner');
          const carousel = document.getElementById('bannerCarousel');
          
          if (!carousel || !viewport) return;
          carousel.innerHTML = '';
          
          // Suppression des anciens indicateurs
          const existingDots = viewport.querySelector('.banner-indicators');
          if (existingDots) existingDots.remove();

          const movies = bannerMovies; 
          if (!movies.length) return;

          // --- 1. Indicateurs (Points) ---
          const indicatorsContainer = document.createElement('div');
          indicatorsContainer.className = 'banner-indicators';
          
          movies.forEach((_, index) => {
              const dot = document.createElement('div');
              dot.className = 'indicator-dot';
              dot.addEventListener('click', (e) => {
                  e.stopPropagation(); 
                  // On vise index + 1 car l'index 0 est maintenant le clone du dernier
                  currentIndex = index + 1;
                  updateCarousel(true);
                  restartInterval();
              });
              indicatorsContainer.appendChild(dot);
          });
          viewport.appendChild(indicatorsContainer);
          const dots = Array.from(indicatorsContainer.children);

          // --- 2. Fonction utilitaire pour cr√©er une carte HTML ---
          function createCard(m) {
            const card = document.createElement('div');
            card.className = 'banner-card';
            
            const duration = m.runtime ? formatRuntime(m.runtime) : '';
            const rating = m.rating ? `‚òÖ ${m.rating}` : '';
            const genres = (m.genres || []).slice(0, 3).join(' ‚Ä¢ ');
            const year = m.year || '';

            card.innerHTML = `
                <img src="${m.netflixPoster || m.poster}" alt="${m.title}" loading="lazy" draggable="false" />
                <div class="banner-gradient"></div>
                <div class="banner-info">
                    <h2 class="text-3xl md:text-5xl font-bold text-white mb-3 drop-shadow-lg leading-tight pointer-events-none">
                        ${escapeHtml(m.title)}
                    </h2>
                    <div class="flex items-center gap-4 text-sm md:text-base font-medium text-slate-200 drop-shadow-md pointer-events-none">
                        ${rating ? `<span class="text-yellow-400 font-bold bg-black/30 px-2 py-0.5 rounded">${rating}</span>` : ''}
                        ${year ? `<span>${year}</span>` : ''}
                        ${duration ? `<span>${duration}</span>` : ''}
                    </div>
                    <div class="mt-2 text-slate-300 text-sm font-medium drop-shadow-md opacity-90 pointer-events-none">
                        ${genres}
                    </div>
                </div>
            `;
            // R√©attacher l'√©v√©nement click
            card.addEventListener('click', () => {
               if (!didMove) openModal(m);
            });
            return card;
          }

          // --- 3. Construction du DOM avec CLONES ---
          
          // A. Clone du DERNIER film (plac√© au d√©but)
          // C'est lui qui appara√Ætra √† gauche du 1er film
          const lastMovieClone = createCard(movies[movies.length - 1]);
          carousel.appendChild(lastMovieClone);

          // B. Les films originaux
          movies.forEach(m => {
             carousel.appendChild(createCard(m));
          });

          // C. Clone du PREMIER film (plac√© √† la fin)
          const firstMovieClone = createCard(movies[0]);
          carousel.appendChild(firstMovieClone);

          const items = Array.from(carousel.querySelectorAll('.banner-card'));

          // --- 4. Logique de positionnement ---
          // On commence √† 1 (le premier vrai film), car 0 est le clone
          let currentIndex = 1; 
          
          let isDragging = false;
          let startPos = 0;
          let currentTranslate = 0;
          let prevTranslate = 0;
          let didMove = false;

          function getPositionX(event) {
            return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
          }

          function setSliderPosition() {
             carousel.style.transform = `translateX(${currentTranslate}px)`;
          }

          function calculateCenterOffset(index) {
            const current = items[index];
            if (!current) return 0;
            const itemOffsetLeft = current.offsetLeft;
            const itemWidth = current.clientWidth;
            const viewportWidth = viewport.clientWidth;
            // Centre parfaitement l'√©l√©ment
            return -(itemOffsetLeft - (viewportWidth - itemWidth) / 2);
          }

          function updateCarousel(useTransition = true) {
            // Mise √† jour des classes active
            items.forEach(item => item.classList.remove('active'));
            if(items[currentIndex]) items[currentIndex].classList.add('active');

            // Mise √† jour des points (dots)
            dots.forEach(d => d.classList.remove('active'));
            // Calcul de l'index "r√©el" pour les points (0 √† N-1)
            let realIndex = currentIndex - 1;
            if (realIndex < 0) realIndex = movies.length - 1; 
            if (realIndex >= movies.length) realIndex = 0;
            if(dots[realIndex]) dots[realIndex].classList.add('active');

            // D√©placement
            const targetTranslate = calculateCenterOffset(currentIndex);
            
            if (useTransition) {
                carousel.style.transition = 'transform 0.6s cubic-bezier(0.25, 1, 0.5, 1)'; 
            } else {
                carousel.style.transition = 'none';
            }
            
            currentTranslate = targetTranslate;
            prevTranslate = targetTranslate;
            setSliderPosition();
          }
          
          // --- 5. GESTION DE L'INFINI (Le saut invisible) ---
          carousel.addEventListener('transitionend', () => {
             // Si on est sur le clone de gauche (Index 0), on saute au vrai dernier
             if (currentIndex === 0) {
                 currentIndex = items.length - 2;
                 updateCarousel(false); // false = pas d'anim, saut instantan√©
             }
             // Si on est sur le clone de droite (Index Max), on saute au vrai premier
             if (currentIndex === items.length - 1) {
                 currentIndex = 1;
                 updateCarousel(false);
             }
          });

          // --- 6. Events Touch / Drag ---
          function touchStart(event) {
            isDragging = true;
            didMove = false;
            startPos = getPositionX(event);
            if (bannerInterval) clearInterval(bannerInterval); 
            carousel.style.transition = 'none';
          }

          function touchMove(event) {
            if (isDragging) {
              const currentPosition = getPositionX(event);
              const diff = currentPosition - startPos;
              if (Math.abs(diff) > 5) didMove = true;
              currentTranslate = prevTranslate + diff;
              setSliderPosition();
            }
          }

          function touchEnd() {
            isDragging = false;
            const movedBy = currentTranslate - prevTranslate;

            if (movedBy < -100) {
                currentIndex += 1;
            } else if (movedBy > 100) {
                currentIndex -= 1;
            }

            // S√©curit√© bornes
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= items.length) currentIndex = items.length - 1;

            updateCarousel(true);
            restartInterval();
          }

          carousel.addEventListener('mousedown', touchStart);
          carousel.addEventListener('touchstart', touchStart, {passive: true});
          carousel.addEventListener('mousemove', touchMove);
          carousel.addEventListener('touchmove', touchMove, {passive: true});
          carousel.addEventListener('mouseup', touchEnd);
          carousel.addEventListener('mouseleave', () => { if(isDragging) touchEnd() });
          carousel.addEventListener('touchend', touchEnd);

          // Initialisation
          updateCarousel(false); 

          function restartInterval() {
             if (bannerInterval) clearInterval(bannerInterval);
             bannerInterval = setInterval(() => {
                currentIndex++;
                updateCarousel(true);
             }, 6000); 
          }

          restartInterval();
          
          window.addEventListener('resize', () => {
              updateCarousel(false);
          });
        }
    }

   function renderStats() {
     if (!statsView) return;
     statsView.innerHTML = '<h2 class="text-2xl font-semibold mb-4">Stats</h2>';

     const today = new Date();
     const movies = (state.all || []).filter(m => 
       !((m.tags && m.tags.includes('wishlist')) || (m.categories && m.categories.includes('wishlist'))) &&
       !(m.added && new Date(m.added) > today)
     );

     const total = movies.length;
     const totalPrice = movies.reduce((acc, m) => acc + (m.price || 0), 0);
     const totalMarket = movies.reduce((acc, m) => acc + (m.marketValue || 0), 0);
     const seenCount = movies.filter(m => localStorage.getItem('seen_' + m.id)).length;
     
     const genreCounts = {};
     movies.forEach(m => (m.genres||[]).forEach(g => { genreCounts[g] = (genreCounts[g]||0) + 1; }));
     const genresArr = Object.entries(genreCounts).sort((a,b)=>b[1]-a[1]);

     const dirCounts = {};
     movies.forEach(m => (m.directors||[]).forEach(d => { dirCounts[d] = (dirCounts[d]||0) + 1; }));
     const dirArr = Object.entries(dirCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);

     const actorCounts = {};
     movies.forEach(m => (m.people || []).forEach(a => { actorCounts[a] = (actorCounts[a] || 0) + 1; }));
     const actorArr = Object.entries(actorCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

     const countryCounts = {};
     movies.forEach(m => { if (m.country) countryCounts[m.country] = (countryCounts[m.country]||0) + 1; });
     const countryArr = Object.entries(countryCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);

     const durations = movies.map(m => m.runtime || 0).filter(v => v>0);
     const totalMinutes = durations.reduce((s,x)=>s+x,0);
     const avgMinutes = durations.length ? Math.round(totalMinutes/durations.length) : 0;

     const yearCounts = {};
     const decadesCount = {};
     movies.forEach(m => { 
        if (m.year) {
            yearCounts[m.year] = (yearCounts[m.year]||0) + 1; 
            const decade = Math.floor(m.year / 10) * 10;
            decadesCount[decade] = (decadesCount[decade] || 0) + 1;
        }
     });
     const topYear = Object.entries(yearCounts).sort((a,b)=>b[1]-a[1])[0];
     const decadesArr = Object.entries(decadesCount).sort((a, b) => a[0] - b[0]);

     const ratingCounts = {};
     for(let i=1; i<=10; i++) ratingCounts[i] = 0;
     movies.forEach(m => {
         if (m.rating) {
             const r = Math.round(m.rating);
             if(ratingCounts[r] !== undefined) ratingCounts[r]++;
         }
     });
     const maxRatingCount = Math.max(...Object.values(ratingCounts)) || 1;

     let shortM = 0, mediumM = 0, longM = 0;
     movies.forEach(m => {
         if(!m.runtime) return;
         if(m.runtime < 100) shortM++;
         else if(m.runtime <= 140) mediumM++;
         else longM++;
     });


     const headerCards = document.createElement('div');
     headerCards.className = 'stats-grid mb-6'; 
     headerCards.innerHTML = `
       <div class="stat-card">
         <div class="stat-title">Total films</div>
         <div class="stat-value">${total}</div>
         <div class="mt-2 text-sm text-slate-400">
            ${topYear ? `Meilleure ann√©e : <span class="text-white">${topYear[0]}</span>` : ''}
         </div>
       </div>

       <div class="stat-card flex flex-col justify-between">
         <div>
            <div class="flex justify-between items-baseline">
                <div class="stat-title">Valeur Achat</div>
                <div class="text-xs text-green-400 bg-green-400/10 px-2 rounded">Pay√©</div>
            </div>
            <div class="stat-value text-green-400">${totalPrice.toFixed(2)} ‚Ç¨</div>
         </div>

         <div class="mt-3 pt-3 border-t border-white/10">
            <div class="flex justify-between items-baseline">
                <div class="stat-title">Valeur March√©</div>
                <div class="text-xs text-purple-400 bg-purple-400/10 px-2 rounded">Estim√©</div>
            </div>
            <div class="stat-value text-purple-400">${totalMarket.toFixed(2)} ‚Ç¨</div>
         </div>
         
         <div class="mt-2 text-xs text-slate-400 flex justify-between">
            <span>Moyenne (achat):</span>
            <span class="text-slate-200">${total > 0 ? (totalPrice / total).toFixed(2) : 0} ‚Ç¨</span>
         </div>
       </div>

       <div class="stat-card">
         <div class="stat-title">Films vus / non vus</div>
         <div class="donut" id="seenDonut"></div>
         <div class="donut-center" id="seenCenter">${seenCount}</div>
         </div>
       <div class="stat-card">
         <div class="stat-title">Temps de visionnage</div>
         <div class="stat-value text-blue-400">
            ${Math.floor(totalMinutes / 60)}h ${(totalMinutes % 60).toString().padStart(2, '0')}
         </div>
         
         <div class="stat-title" style="margin-top:.5rem; font-weight:600; font-size:.85rem">Moyenne / film</div>
         <div class="stat-value" style="font-size:1rem">${avgMinutes} min</div>
       </div>
     `;
     statsView.appendChild(headerCards);

     const detailsGrid = document.createElement('div');
     detailsGrid.className = 'stats-grid'; 

     const genreCard = document.createElement('div');
     genreCard.className = 'stat-card';
     genreCard.innerHTML = `<div class="stat-title">R√©partition par genre</div><div id="genreList" class="mt-3"></div>`;
     const genreList = genreCard.querySelector('#genreList');
     
     if (genresArr.length === 0) {
       genreList.innerHTML = '<div class="text-xs opacity-70">Aucun genre trouv√©.</div>';
     } else {
       const max = Math.max(...genresArr.map(([g,c])=>c));
       genresArr.slice(0,8).forEach(([g,c])=>{
         const row = document.createElement('div');
         row.style.display = "flex";
         row.style.alignItems = "center";
         row.style.marginBottom = "6px";
         
         row.innerHTML = `
           <div style="width:110px; min-width:110px; font-size:0.85rem; color:#e6eef8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${g}">
             ${g}
           </div>
           <div style="flex:1; margin: 0 8px; height:10px; background:rgba(255,255,255,0.1); border-radius:99px; overflow:hidden;">
              <div class="bar-fill" style="width:${Math.round((c/max)*100)}%; background: linear-gradient(90deg, #f97316, #ef4444); border-radius:99px;"></div>
           </div>
           <div style="min-width:25px; text-align:right; font-size:0.85rem; color:#cbd5e1; font-weight:bold;">${c}</div>
         `;
         genreList.appendChild(row);
       });
     }
     detailsGrid.appendChild(genreCard);

     const ratingCard = document.createElement('div');
     ratingCard.className = 'stat-card';
     ratingCard.innerHTML = `<div class="stat-title">Notes (√âtoiles)</div><div id="ratingList" class="mt-3"></div>`;
     const ratingList = ratingCard.querySelector('#ratingList');
     for(let r=10; r>=1; r--) {
         const count = ratingCounts[r];
         if (count > 0) {
             ratingList.innerHTML += `
               <div class="genre-bar">
                 <div class="genre-label" style="width:30px; text-align:center;">‚òÖ ${r}</div>
                 <div class="bar">
                    <div class="bar-fill" style="width:${Math.round((count / maxRatingCount) * 100)}%; background: linear-gradient(90deg, #3b82f6, #8b5cf6);"></div>
                 </div>
                 <div style="min-width:30px;text-align:right;font-size:.85rem;color:#cbd5e1">${count}</div>
               </div>
             `;
         }
     }
     detailsGrid.appendChild(ratingCard);

     const dirCard = document.createElement('div');
     dirCard.className = 'stat-card';
     dirCard.innerHTML = `<div class="stat-title">R√©alisateurs fr√©quents</div>`;
     const dirList = document.createElement('div');
     dirList.style.marginTop = '.5rem';
     if (dirArr.length===0) dirList.innerHTML = '<div class="text-xs opacity-70">Aucun r√©alisateur.</div>';
     else dirArr.forEach(([d,c])=> dirList.innerHTML += `<div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">${d} ‚Äî <span style="color:#cbd5e1">${c}</span></div>`);
     dirCard.appendChild(dirList);
     detailsGrid.appendChild(dirCard);

     const actorCard = document.createElement('div');
     actorCard.className = 'stat-card';
     actorCard.innerHTML = `<div class="stat-title">Acteurs fr√©quents</div>`;
     const actorList = document.createElement('div');
     actorList.style.marginTop = '.5rem';
     if (actorArr.length === 0) {
        actorList.innerHTML = '<div class="text-xs opacity-70">Aucun acteur renseign√©.</div>';
     } else {
        actorArr.forEach(([actor, count]) => {
            actorList.innerHTML += `
            <div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">
                ${actor} ‚Äî <span style="color:#cbd5e1">${count}</span>
            </div>`;
        });
     }
     actorCard.appendChild(actorList);
     detailsGrid.appendChild(actorCard);

     const countryCard = document.createElement('div');
     countryCard.className = 'stat-card';
     countryCard.innerHTML = `<div class="stat-title">Pays d'origine</div>`;
     const countryListEl = document.createElement('div');
     countryListEl.style.marginTop = '.5rem';
     if (countryArr.length===0) countryListEl.innerHTML = '<div class="text-xs opacity-70">Aucun pays renseign√©.</div>';
     else countryArr.forEach(([c,cnt]) => countryListEl.innerHTML += `<div style="font-size:.9rem;color:#e6eef8;margin-bottom:.35rem">${c} ‚Äî <span style="color:#cbd5e1">${cnt}</span></div>`);
     countryCard.appendChild(countryListEl);
     detailsGrid.appendChild(countryCard);

     const decadeCard = document.createElement('div');
     decadeCard.className = 'stat-card';
     decadeCard.innerHTML = `<div class="stat-title">Par d√©cennie</div><div class="flex flex-wrap gap-2 mt-3"></div>`;
     const decadeContainer = decadeCard.querySelector('div:last-child');
     decadesArr.forEach(([dec, count]) => {
         decadeContainer.innerHTML += `
            <div class="flex flex-col items-center justify-center bg-white/5 p-2 rounded-lg border border-white/5 min-w-[60px]">
                <span class="text-red-400 font-bold text-xs tracking-wider">${dec}s</span>
                <span class="text-white font-bold">${count}</span>
            </div>
         `;
     });
     detailsGrid.appendChild(decadeCard);

     const runtimeDistCard = document.createElement('div');
     runtimeDistCard.className = 'stat-card';
     runtimeDistCard.innerHTML = `
        <div class="stat-title">Format (Dur√©e)</div>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between items-center text-sm border-b border-white/5 pb-2">
                <span class="text-slate-400">Court (< 1h40)</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${shortM}</span>
            </div>
            <div class="flex justify-between items-center text-sm border-b border-white/5 pb-2">
                <span class="text-slate-400">Standard</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${mediumM}</span>
            </div>
            <div class="flex justify-between items-center text-sm">
                <span class="text-slate-400">Long (> 2h20)</span> 
                <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded">${longM}</span>
            </div>
        </div>
     `;
     detailsGrid.appendChild(runtimeDistCard);

     let count4k = 0;
     let countBluray = 0;
     let countSteelbook = 0;
     let countAmaray = 0;

     movies.forEach(m => {
         const tags = (m.tags || []).map(t => t.toLowerCase()); 
         if (tags.some(t => t.includes('4k'))) count4k++;
         if (tags.some(t => t.includes('blu-ray') || t.includes('bluray'))) countBluray++;
         if (tags.some(t => t.includes('steelbook'))) countSteelbook++;
         if (tags.some(t => t.includes('amaray'))) countAmaray++;
     });

     const formatCard = document.createElement('div');
     formatCard.className = 'stat-card';
     formatCard.innerHTML = `
        <div class="stat-title">Formats & √âditions</div>
        <div class="grid grid-cols-2 gap-3 mt-3">
            <div class="flex flex-col items-center justify-center bg-black/40 border border-yellow-500/30 p-2 rounded-lg">
                <span class="text-yellow-500 font-bold text-xs uppercase tracking-wider">4K UHD</span>
                <span class="text-white text-xl font-bold">${count4k}</span>
            </div>
            <div class="flex flex-col items-center justify-center bg-blue-900/20 border border-blue-500/30 p-2 rounded-lg">
                <span class="text-blue-400 font-bold text-xs uppercase tracking-wider">Blu-ray</span>
                <span class="text-white text-xl font-bold">${countBluray}</span>
            </div>
            <div class="col-span-2 flex justify-center py-1">
                <div class="h-px bg-white/10 w-3/4 rounded-full"></div>
            </div>
            <div class="flex flex-col items-center justify-center bg-slate-700/40 border border-slate-500/50 p-2 rounded-lg">
                <span class="text-slate-300 font-bold text-xs uppercase tracking-wider">Steelbook</span>
                <span class="text-white text-xl font-bold">${countSteelbook}</span>
            </div>
            <div class="flex flex-col items-center justify-center bg-white/5 border border-white/10 p-2 rounded-lg">
                <span class="text-slate-400 font-bold text-xs uppercase tracking-wider">Amaray</span>
                <span class="text-white text-xl font-bold">${countAmaray}</span>
            </div>
        </div>
     `;
     detailsGrid.appendChild(formatCard);

     statsView.appendChild(detailsGrid);

     const donut = statsView.querySelector('#seenDonut');
     const seenCenterEl = statsView.querySelector('#seenCenter');
     if (donut) {
       const pct = total ? Math.round((seenCount/total)*100) : 0;
       donut.style.background = `conic-gradient(#f97316 0 ${pct}%, #334155 ${pct}% 100%)`;
       if (seenCenterEl) seenCenterEl.textContent = `${pct}%`;
     }

     const currentYear = new Date().getFullYear();
     let addedThisYear = 0;
     let addedLast30Days = 0;
     const thirtyDaysAgo = new Date();
     thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

     movies.forEach(m => {
         if (m.added) {
             const dateAdded = new Date(m.added);
             if (dateAdded.getFullYear() === currentYear) addedThisYear++;
             if (dateAdded >= thirtyDaysAgo) addedLast30Days++;
         }
     });

     const growthCard = document.createElement('div');
     growthCard.className = 'stat-card';
     growthCard.innerHTML = `
        <div class="stat-title">Croissance</div>
        <div class="grid grid-cols-2 gap-4 mt-4 text-center">
            <div class="bg-white/5 rounded-lg p-2 border border-white/5">
                <div class="text-2xl font-bold text-green-400">+${addedLast30Days}</div>
                <div class="text-xs text-slate-400 mt-1">30 jours</div>
            </div>
            <div class="bg-white/5 rounded-lg p-2 border border-white/5">
                <div class="text-2xl font-bold text-blue-400">+${addedThisYear}</div>
                <div class="text-xs text-slate-400 mt-1">En ${currentYear}</div>
            </div>
        </div>
        <div class="mt-4 text-xs text-center text-slate-500">
            Dernier ajout : <span class="text-slate-300">${movies.length ? movies.sort((a,b)=> new Date(b.added)-new Date(a.added))[0].title : 'Aucun'}</span>
        </div>
     `;
     detailsGrid.appendChild(growthCard);

     const monthCounts = Array(12).fill(0);
     const monthNames = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sep", "Oct", "Nov", "D√©c"];
     
     movies.forEach(m => {
         if (m.added) {
             const d = new Date(m.added);
             monthCounts[d.getMonth()]++;
         }
     });
     
     const maxMonth = Math.max(...monthCounts) || 1;

     const seasonCard = document.createElement('div');
     seasonCard.className = 'stat-card';
     seasonCard.innerHTML = `<div class="stat-title">P√©riodes d'ajout</div>`;
     
     const seasonChart = document.createElement('div');
     seasonChart.className = "mt-3 grid grid-cols-6 gap-2"; 
     
     monthNames.forEach((name, index) => {
         const count = monthCounts[index];
         const opacity = 0.2 + (count / maxMonth) * 0.8; 
         seasonChart.innerHTML += `
            <div class="flex flex-col items-center bg-white/5 rounded p-1 border border-white/5">
                <div class="text-[10px] text-slate-400 uppercase">${name}</div>
                <div class="text-sm font-bold text-green-400" style="opacity:${opacity}">${count}</div>
            </div>
         `;
     });
     
     seasonCard.appendChild(seasonChart);
     detailsGrid.appendChild(seasonCard);
   }

    function renderGrid() {
     els.grid.innerHTML = '';
     let countText = `${state.filtered.length} film${state.filtered.length > 1 ? 's' : ''}`;
     els.count.textContent = countText;

     for (const m of state.filtered) {
       const posterSrc = m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;

       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3] bg-black/40">
           <img src="${posterSrc}" loading="lazy" alt="${m.title}" class="w-full aspect-[2/3] object-cover rounded-lg group-hover:scale-105 transition-transform duration-300"/>
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
           <div class="flex flex-wrap gap-1 pt-1">
             ${(m.genres||[]).slice(0,3).map(g => `<span class='text-[10px] px-1.5 py-0.5 rounded-full bg-white/10'>${escapeHtml(g)}</span>`).join('')}
           </div>
          </div>
        `;
       card.addEventListener('click', () => openModal(m));
       els.grid.appendChild(card);
      }
    }

    function renderUpcomingView() {
     const container = document.getElementById('upcomingView');
     container.innerHTML = '';

     const today = new Date();
     const upcomingMovies = state.all
       .filter(m => {
         const isFuture = m.added && new Date(m.added) > today;
         const isWishlist = (m.categories && m.categories.includes('wishlist')) || 
                            (m.tags && m.tags.includes('wishlist'));
         return isFuture && !isWishlist; 
       })
       .sort((a, b) => new Date(a.added) - new Date(b.added));

     if (upcomingMovies.length === 0) {
       container.innerHTML = '<p class="text-slate-200">Aucun film √† venir pour le moment.</p>';
       return;
     }

     const grid = document.createElement('div');
     grid.className = 'grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6';

     upcomingMovies.forEach(m => {
       const posterSrc = m.poster || m.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
    
       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3] bg-black/40">
           <img src="${posterSrc}" alt="${m.title}" 
                class="w-full aspect-[2/3] object-cover rounded-lg group-hover:scale-105 transition-transform duration-300"/>
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
         </div>
        `;
       card.addEventListener('click', () => openModal(m));
        grid.appendChild(card);
     });

     container.appendChild(grid);
   }
    
    function renderWishlistView() {
     const container = document.getElementById('wishlistView');
     container.innerHTML = '';

     const wishlistMovies = state.all.filter(m => 
       (m.tags && m.tags.includes('wishlist')) || 
       (m.categories && m.categories.includes('wishlist'))
     );

     if (wishlistMovies.length === 0) {
       container.innerHTML = '<p class="text-slate-200">Aucun film dans la wishlist.</p>';
       return;
     }

     const grid = document.createElement('div');
     grid.className = 'grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6';

     wishlistMovies.forEach(m => {
       const posterSrc = m.poster || m.netflixPoster || 
         `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;

       const card = document.createElement('article');
       card.className = 'group relative rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/10 transition shadow cursor-pointer';
       card.innerHTML = `
         <div class="aspect-[2/3] bg-black/40">
           <img src="${posterSrc}" alt="${m.title}" 
                class="w-full aspect-[2/3] object-cover rounded-lg group-hover:scale-105 transition-transform duration-300"/>
         </div>
         <div class="p-3 space-y-1">
           <h3 class="font-medium leading-tight line-clamp-2">${escapeHtml(m.title)}</h3>
           <div class="text-xs opacity-80 flex items-center gap-2">
             ${m.year ? `<span>${m.year}</span>` : ''}
             ${m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : ''}
             ${m.rating ? `<span class="px-1.5 py-0.5 rounded bg-white/10">‚òÖ ${m.rating}</span>` : ''}
           </div>
         </div>
       `;
       card.addEventListener('click', () => openModal(m));
       grid.appendChild(card);
     });

     container.appendChild(grid);
   }

    function formatRuntime(minutes) {
     if (!minutes) return "Dur√©e inconnue";
     const h = Math.floor(minutes / 60);
     const m = minutes % 60;
     return `${h}h${m.toString().padStart(2,"0")}`;
    }

    function formatAddedDate(dateString) {
     if (!dateString) return '';
     try {
       const date = new Date(dateString);
       return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
     } catch (e) {
       return dateString;
     }
    }

    function placeholderSVG(text){
      const bg = '#0f172a';
      const fg = '#94a3b8';
      return `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='600'>
        <rect width='100%' height='100%' fill='${bg}'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='${fg}' font-family='system-ui,Segoe UI,Arial' font-size='22'>${(text||'Poster')}</text>
      </svg>`;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function openModal(m) {
     const content = document.getElementById('modalContent');
     if (!content) return;

     let showingAlt = false;
     const mainPoster = m.poster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(m.title))}`;
     const altPoster = m.altPoster || null;

     els.modalPoster.src = mainPoster;
     els.modalTitle.textContent = m.title;
     els.modalOverview.textContent = m.overview || '';
     
     const metaHtml = [
       m.year ? `<span>${m.year}</span>` : '',
       m.runtime ? `<span>‚Ä¢ ${formatRuntime(m.runtime)}</span>` : '',
       m.rating ? `<span>‚Ä¢ ‚òÖ ${m.rating}</span>` : ''
     ];

     if (m.added) {
       metaHtml.push(`<span>‚Ä¢ Ajout√© le ${formatAddedDate(m.added)}</span>`);
     }

     els.modalMeta.innerHTML = metaHtml.join(' ');
     els.modalOverview.textContent = m.overview || '';

     const price = m.price ? Number(m.price) : 0;
     const value = m.marketValue ? Number(m.marketValue) : 0;

     if (price > 0 || value > 0) {
        const priceStr = price.toFixed(2) + ' ‚Ç¨';
        const valueStr = value.toFixed(2) + ' ‚Ç¨';
        
        els.modalPrice.innerHTML = `
            <span class="text-slate-400 text-base font-normal">Achat :</span> 
            <span class="text-green-400">${priceStr}</span>
            <span class="mx-2 text-slate-600">/</span>
            <span class="text-slate-400 text-base font-normal">Valeur :</span> 
            <span class="text-purple-400">${valueStr}</span>
        `;
        els.modalPrice.classList.remove('hidden');
     } else {
        els.modalPrice.innerHTML = '';
        els.modalPrice.classList.add('hidden');
     }

     let userRating = localStorage.getItem("myrating_" + m.id) || "";
     const oldRatingBlock = document.getElementById("userRatingBlock");
     if (oldRatingBlock) oldRatingBlock.remove();

     let ratingHTML = `
       <div id="userRatingBlock" class="mt-1 flex items-center gap-2 text-sm">
         <span class="opacity-80">Ma note :</span>
         <select id="userRatingSelect" class="px-2 py-1 rounded bg-white/10 text-slate-900 md:text-white">
           <option value="">‚Äì</option>
           ${[...Array(10)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
         </select>
       </div>
     `;

     els.modalMeta.insertAdjacentHTML("afterend", ratingHTML);

     const selectRating = document.getElementById("userRatingSelect");
     selectRating.value = userRating;
     selectRating.addEventListener("change", () => {
       if (selectRating.value === "") localStorage.removeItem("myrating_" + m.id);
       else localStorage.setItem("myrating_" + m.id, selectRating.value);
     });

     const oldSeenBtn = document.getElementById('toggleSeenBtn');
     if (oldSeenBtn) oldSeenBtn.remove();

     const seenBtn = document.createElement('button');
     seenBtn.id = 'toggleSeenBtn'; 
     const isSeen = localStorage.getItem('seen_' + m.id);

     seenBtn.className = "px-4 py-2 rounded bg-white/10 hover:bg-white/20 ml-2 transition-colors text-xs font-semibold";
     if (isSeen) seenBtn.classList.add('text-green-400', 'bg-green-900/30'); 
     seenBtn.innerHTML = isSeen ? "üëÅÔ∏è Visionn√©" : "‚≠ï Non visionn√©";

     seenBtn.onclick = () => {
       if (localStorage.getItem('seen_' + m.id)) {
         localStorage.removeItem('seen_' + m.id);
         seenBtn.innerHTML = "‚≠ï Non visionn√©";
         seenBtn.classList.remove('text-green-400', 'bg-green-900/30');
       } else {
         localStorage.setItem('seen_' + m.id, 'true');
         seenBtn.innerHTML = "üëÅÔ∏è Visionn√©";
         seenBtn.classList.add('text-green-400', 'bg-green-900/30');
       }
       applyFilters();
     };
     
     els.modalMeta.parentNode.insertBefore(seenBtn, els.modalMeta.nextSibling);

     if (m.people && m.people.length) {
       els.modalActors.innerHTML = m.people
         .map(actor => `<span class="actor-link text-red-400 hover:underline cursor-pointer">${actor}</span>`)
         .join(', ');
       els.modalActors.querySelectorAll('.actor-link').forEach(el => {
         el.addEventListener('click', (e) => {
           e.stopPropagation();
           state.query = el.textContent.trim();
           els.search.value = state.query;
           currentView = 'grid';
           setActiveTab('grid');
           hideAllViews();
           document.getElementById('gridView').classList.remove('hidden');
           applyFilters();
           closeModal();
         });
       });
     } else {
       els.modalActors.textContent = '';
     }

     els.modalCountry.innerHTML = m.country ? `Pays d'origine : ${escapeHtml(m.country)}` : '';
     els.modalTags.innerHTML = (m.tags || []).map(t => 
       `<span class='tag-link text-xs px-2 py-1 rounded-full bg-white/10 hover:bg-red-600 transition cursor-pointer'>${escapeHtml(t)}</span>`
     ).join('');

     els.modalTags.querySelectorAll('.tag-link').forEach(el => {
         el.addEventListener('click', (e) => {
           e.stopPropagation();
           state.query = el.textContent.trim();
           els.search.value = state.query;
           currentView = 'grid';
           setActiveTab('grid');
           hideAllViews();
           document.getElementById('gridView').classList.remove('hidden');
           applyFilters();
           closeModal();
         });
       });

     const posterWrapper = els.modalPoster.parentElement;
     const oldBtn = posterWrapper.querySelector('.switchPosterBtn');
     if (oldBtn) oldBtn.remove();

     if (altPoster) {
       const switchBtn = document.createElement('button');
       switchBtn.className = "switchPosterBtn absolute top-1/2 right-2 -translate-y-1/2 bg-black/60 text-white p-2 rounded-full z-10 hover:bg-black/80";
       switchBtn.innerHTML = "‚û°Ô∏è";
       posterWrapper.appendChild(switchBtn);

       switchBtn.addEventListener('click', () => {
         if (showingAlt) {
           els.modalPoster.src = mainPoster;
           switchBtn.innerHTML = "‚û°Ô∏è";
           switchBtn.classList.remove("left-2");
           switchBtn.classList.add("right-2");
         } else {
           els.modalPoster.src = altPoster;
           switchBtn.innerHTML = "‚¨ÖÔ∏è";
           switchBtn.classList.remove("right-2");
           switchBtn.classList.add("left-2");
         }
         showingAlt = !showingAlt;
       });
     }

     els.modal.classList.remove('hidden');
     content.classList.remove('scale-100','opacity-100');
     content.classList.add('scale-95','opacity-0');

     requestAnimationFrame(() => {
       content.classList.remove('scale-95','opacity-0');
       content.classList.add('scale-100','opacity-100');
     });
   }

    function closeModal() {
     const content = document.getElementById('modalContent');
     content.classList.remove('scale-100', 'opacity-100');
     content.classList.add('scale-95', 'opacity-0');

     setTimeout(() => {
       els.modal.classList.add('hidden');
     }, 200);
    }

   function hideAllViews() {
     document.getElementById('mainView').classList.add('hidden');
     document.getElementById('gridView').classList.add('hidden');
     document.getElementById('upcomingView').classList.add('hidden');
     document.getElementById('wishlistView').classList.add('hidden');
     document.getElementById('statsView').classList.add('hidden');
   }

   document.getElementById('tabUpcoming').addEventListener('click', () => {
     currentView = 'upcoming';
     setActiveTab('upcoming');
     hideAllViews();
     document.getElementById('upcomingView').classList.remove('hidden');
     applyFilters();
   });

   document.getElementById('tabWishlist').addEventListener('click', () => {
     currentView = 'wishlist';
     setActiveTab('wishlist');
     hideAllViews();
     document.getElementById('wishlistView').classList.remove('hidden');
     applyFilters();
   });

   tabStatsBtn.addEventListener('click', () => {
     currentView = 'stats';
     setActiveTab('stats');
     hideAllViews();
     statsView.classList.remove('hidden');
     renderStats();
   });

    els.search.addEventListener('input', e=>{ state.query = e.target.value; applyFilters(); });
    els.genre.addEventListener('change', e=>{ state.genre = e.target.value; applyFilters(); });
    els.yearExact.addEventListener('input', e=>{ state.yearExact = e.target.value; applyFilters(); });
    els.runtime.addEventListener('change', e =>{ state.runtime = e.target.value; applyFilters(); });
    els.sort.addEventListener('change', e=>{ state.sort = e.target.value; applyFilters(); });
    els.country.addEventListener('change', e => {state.country = e.target.value; applyFilters(); });
    els.period.addEventListener('change', e => {state.period = e.target.value; applyFilters(); });
    
    els.reset.addEventListener('click', ()=>{
        resetFilters();
    });    

    els.randomBtn.addEventListener('click', () => {
        if (state.filtered.length === 0) {
            alert("Aucun film trouv√© dans la s√©lection actuelle !");
            return;
        }

        const overlay = document.getElementById('randomRoulette');
        const rPoster = document.getElementById('roulettePoster');
        const rTitle = document.getElementById('rouletteTitle');
        
        overlay.classList.remove('hidden');
        overlay.classList.remove('opacity-0');
        rPoster.classList.remove('shake-effect'); // Reset effet

        let duration = 0;
        let speed = 50; 
        let maxDuration = 2000; 
        let shuffles = 0;
        let lastIndex = -1;

        const shuffle = () => {
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * state.filtered.length);
            } while (randomIndex === lastIndex && state.filtered.length > 1);
            
            lastIndex = randomIndex;
            const movie = state.filtered[randomIndex];

            rPoster.src = movie.poster || movie.netflixPoster || `data:image/svg+xml;utf8,${encodeURIComponent(placeholderSVG(movie.title))}`;
            rTitle.textContent = movie.title;
            
            duration += speed;
            shuffles++;

            if (duration < maxDuration) {
                if (duration > maxDuration * 0.7) speed += 20; 
                setTimeout(shuffle, speed);
            } else {
                finish(movie);
            }
        };

        const finish = (movie) => {
            rTitle.textContent = "üé¨ " + movie.title;
            rTitle.classList.remove('animate-pulse');
            rTitle.classList.add('text-green-400'); // Titre devient vert
            rPoster.parentElement.classList.add('shake-effect'); // Tremblement
            rPoster.parentElement.classList.remove('ring-white/5');
            rPoster.parentElement.classList.add('ring-green-500'); // Bordure verte

            setTimeout(() => {
                overlay.classList.add('opacity-0');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    rTitle.classList.add('animate-pulse');
                    rTitle.classList.remove('text-green-400');
                    rPoster.parentElement.classList.remove('ring-green-500');
                    rPoster.parentElement.classList.add('ring-white/5');
                    
                    openModal(movie);
                }, 500); // Temps de la transition CSS opacity
            }, 1200);
        };

        shuffle();
    });

    els.modalClose.addEventListener('click', closeModal);
    els.modalBackdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
     if (e.key === 'Escape' && !els.modal.classList.contains('hidden')) {
      closeModal();
     }
    });

    els.sortDirBtn.addEventListener('click', ()=>{ 
     state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
     els.sortDirBtn.textContent = state.sortDir === "asc" ? "‚¨ÜÔ∏é" : "‚¨áÔ∏é";
     applyFilters();
    });

    els.jsonFile.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!parsed.movies || !Array.isArray(parsed.movies)) throw new Error('Sch√©ma invalide');
        bannerMovies = [];
        state.all = normalize(parsed.movies);
        initFilters();
        resetFilters();
      }catch(err){
        alert('Impossible de lire ce JSON. V√©rifiez le sch√©ma (voir Aide).');
      }
    });

   document.getElementById('tabMain').addEventListener('click', () => {
     currentView = 'netflix';
     setActiveTab('netflix');
     hideAllViews();
     document.getElementById('mainView').classList.remove('hidden');
     applyFilters();
   });

   document.getElementById('tabGrid').addEventListener('click', () => {
      currentView = 'grid';
      setActiveTab('grid');
      hideAllViews();
      document.getElementById('gridView').classList.remove('hidden');
      
      if (filterInputsContainer) {
          if (toggleFiltersBtn) toggleFiltersBtn.textContent = filterInputsContainer.classList.contains('hidden') ? "Afficher les filtres & tri" : "Masquer les filtres & tri";
      }
      applyFilters();
    });

   loadInitial();
  </script>

  <script>
    const GITHUB_USERNAME = "Mathis1371"; // Ex: jean-dupont
    const GITHUB_REPO = "Collection-blu-ray";         // Ex: ma-collection-bluray

    const btn = document.getElementById('bugReportBtn');
    
    const userAgent = navigator.userAgent;
    const screenRes = `${window.screen.width}x${window.screen.height}`;
    
    const title = encodeURIComponent("Rapport de bug");
    const body = encodeURIComponent(
  `**Description du probl√®me :**
  (D√©crivez ce qu'il se passe ici...)

  **Comment reproduire le bug :**
  1. 
  2. 
  3. 

  ---
  *Infos techniques (automatique) :*
  *Navigateur : ${userAgent}*
  *R√©solution : ${screenRes}*`
    );

    btn.href = `https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/issues/new?title=${title}&body=${body}`;
  </script>

</body>
</html>
